<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>美育虎 Tigers Elite Pro 旗艦版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        // --- 核心配置 ---
        const firebaseConfig = {
            apiKey: "BGQ1BXdmLUMnvQEy_5woULXzHLgjp4XgGW6cCoUxjTp_hAfv_t0tTT1_xWsiyVxCGtUlfOPNdJYQ-FitlzXg-Dw",
            authDomain: "tigers-elite-v2.firebaseapp.com",
            projectId: "tigers-elite-v2",
            appId: "tigers-elite-v1"
        };
        
        let app, auth, db;
        let members = [];
        let attendanceData = {}; 
        let viewMode = 'coach';
        let currentDate = new Date().toISOString().split('T')[0];

        async function initSystem() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                onAuthStateChanged(auth, (user) => { 
                    if (user) loadMembers(); 
                    else signInAnonymously(auth); 
                });
            } catch (e) {
                renderError(e.message);
            }
        }

        // 1. 載入總名冊
        async function loadMembers() {
            const memCol = collection(db, 'artifacts', 'tigers-elite-v1', 'public', 'data', 'members');
            onSnapshot(memCol, (snap) => {
                members = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                loadAttendance(currentDate); // 確保名冊載入後再載入點名
            });
        }

        // 2. 載入特定日期點名 (含自動同步邏輯)
        async function loadAttendance(date) {
            const docRef = doc(db, 'artifacts', 'tigers-elite-v1', 'public', 'data', 'attendance', date);
            const snap = await getDoc(docRef);
            
            if (snap.exists()) {
                attendanceData = snap.data();
            } else {
                // 自動同步：如果當天沒紀錄，抓取目前所有成員初始化
                attendanceData = {};
                members.forEach(m => {
                    attendanceData[m.id] = { name: m.name, status: 'none', feedback: '', role: m.role };
                });
                if (members.length > 0) await setDoc(docRef, attendanceData);
            }
            renderApp();
        }

        // 3. 一鍵全體出席
        window.markAllPresent = async () => {
            if (!confirm(`確定要將今日 (${currentDate}) 所有球員設為出席嗎？`)) return;
            const docRef = doc(db, 'artifacts', 'tigers-elite-v1', 'public', 'data', 'attendance', currentDate);
            Object.keys(attendanceData).forEach(id => {
                attendanceData[id].status = 'present';
            });
            await setDoc(docRef, attendanceData);
            renderApp();
        };

        window.updateStatus = async (id, status) => {
            const docRef = doc(db, 'artifacts', 'tigers-elite-v1', 'public', 'data', 'attendance', currentDate);
            attendanceData[id] = { ...attendanceData[id], status };
            await setDoc(docRef, attendanceData);
            renderApp();
        };

        window.updateFeedback = async (id, text) => {
            const docRef = doc(db, 'artifacts', 'tigers-elite-v1', 'public', 'data', 'attendance', currentDate);
            attendanceData[id] = { ...attendanceData[id], feedback: text };
            await setDoc(docRef, attendanceData);
        };

        window.addMember = async () => {
            const name = prompt("球員姓名:");
            const role = prompt("組別 (u9/u10/coach):", "u9");
            if (!name) return;
            await addDoc(collection(db, 'artifacts', 'tigers-elite-v1', 'public', 'data', 'members'), {
                name, role, createdAt: new Date().toISOString()
            });
            // 新增後重新載入當天，以觸發同步
            loadAttendance(currentDate);
        };

        window.changeDate = (date) => { currentDate = date; loadAttendance(date); };
        window.switchView = (mode) => { viewMode = mode; renderApp(); };

        window.searchChild = async () => {
            const name = document.getElementById('parentSearchInput').value.trim();
            const container = document.getElementById('searchResult');
            container.innerHTML = `<p class="animate-pulse text-slate-500">搜尋中...</p>`;

            const member = members.find(m => m.name === name);
            if (!member) { container.innerHTML = `<p class="text-rose-400">找不到