<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>美育虎 Tigers Elite 管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, updateDoc, deleteDoc, addDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        // 配置初始化 (RULE 1: 路徑必須正確)
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'tigers-elite-v1';
        const initialToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- 全局狀態 ---
        let members = [];
        let currentUser = null;
        let viewMode = 'coach'; 
        let unsubscribeData = null;

        // --- 初始化 Auth (RULE 3: 必須先完成 Auth 再執行 Firestore) ---
        async function initAuth() {
            try {
                // 優先使用 Custom Token，否則使用匿名登錄
                if (initialToken) {
                    await signInWithCustomToken(auth, initialToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                // 監聽狀態變化
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        console.log("身份驗證完成:", user.uid);
                        loadData(); // 身份確認後才載入
                    } else {
                        console.warn("未偵測到用戶身份");
                    }
                });
            } catch (err) {
                console.error("Auth Error:", err);
                showToast("連線系統失敗，請重新整理頁面");
            }
        }

        // --- 載入數據 (符合 RULE 1 的路徑結構) ---
        function loadData() {
            // 安全守衛：必須有用戶對象
            if (!auth.currentUser) return;

            // 強制路徑格式: /artifacts/{appId}/public/data/{collectionName}
            const collectionPath = collection(db, 'artifacts', appId, 'public', 'data', 'members');
            
            if (unsubscribeData) unsubscribeData();

            // 設置數據監聽 (RULE 2: 不使用複雜查詢，避免索引錯誤)
            unsubscribeData = onSnapshot(collectionPath, (snapshot) => {
                members = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // 排序邏輯：教練 -> U9 -> U10 (在 JavaScript 記憶體中排序)
                members.sort((a, b) => {
                    const roleOrder = { 'coach': 0, 'u9': 1, 'u10': 2 };
                    const roleDiff = (roleOrder[a.role] ?? 99) - (roleOrder[b.role] ?? 99);
                    if (roleDiff !== 0) return roleDiff;
                    return (a.order || 0) - (b.order || 0);
                });
                renderApp();
            }, (err) => {
                console.error("Firestore Permission Error:", err);
                // 權限錯誤自動重試機制
                if (err.code === 'permission-denied') {
                    console.log("嘗試修復權限衝突...");
                    setTimeout(() => { if(auth.currentUser) loadData(); }, 3000);
                }
            });
        }

        // --- 主要功能函數 ---
        window.toggleAttendance = async (id, status) => {
            if (!auth.currentUser) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'members', id);
            try {
                await updateDoc(docRef, { 
                    status: status,
                    lastUpdate: new Date().toISOString()
                });
            } catch (err) {
                console.error("Update Error:", err);
            }
        };

        window.updateFeedback = async (id, text) => {
            if (!auth.currentUser) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'members', id);
            try {
                await updateDoc(docRef, { feedback: text });
                showToast("回饋已儲存");
            } catch (err) {
                console.error("Feedback Error:", err);
            }
        };

        window.addMember = async () => {
            if (!auth.currentUser) return;
            const name = prompt("輸入姓名:");
            const role = document.getElementById('roleSelector').value;
            if (!name) return;
            
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'members'), {
                    name: name.trim(), 
                    role, 
                    status: 'present', 
                    order: members.length, 
                    feedback: '', 
                    createdAt: new Date().toISOString()
                });
            } catch (err) {
                console.error("Add Member Error:", err);
                showToast("新增失敗，請檢查權限");
            }
        };

        window.deleteMember = async (id) => {
            if (!auth.currentUser) return;
            if (confirm("確定刪除此人員？")) {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'members', id));
                } catch (err) {
                    console.error("Delete Error:", err);
                }
            }
        };

        window.exportAsImage = () => {
            const element = document.getElementById('attendanceTable');
            html2canvas(element, { 
                backgroundColor: '#020617', 
                scale: 2,
                useCORS: true
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `美育虎點名表_${new Date().toLocaleDateString()}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
            });
        };

        window.switchView = (mode) => {
            viewMode = mode;
            renderApp();
        };

        window.searchChild = () => {
            const name = document.getElementById('parentSearchInput').value.trim();
            const result = members.find(m => m.name === name);
            const container = document.getElementById('searchResult');
            if (result) {
                container.innerHTML = `
                    <div class="bg-slate-900 border-2 border-amber-500/50 p-6 rounded-xl animate-pulse">
                        <h3 class="text-2xl font-bold text-amber-500 mb-2">${result.name}</h3>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="bg-slate-800 p-3 rounded">
                                <p class="text-xs text-slate-400 font-bold">當前狀態</p>
                                <p class="text-lg ${result.status === 'present' ? 'text-green-400' : 'text-red-400'} font-black">
                                    ${result.status === 'present' ? '出席' : '缺席'}
                                </p>
                            </div>
                            <div class="bg-slate-800 p-3 rounded">
                                <p class="text-xs text-slate-400 font-bold">組別</p>
                                <p class="text-lg uppercase text-slate-200 font-black">${result.role}</p>
                            </div>
                        </div>
                        <div class="bg-amber-500/10 border border-amber-500/30 p-4 rounded text-amber-200">
                            <p class="text-xs mb-1 font-bold">教練今日評語：</p>
                            <p class="leading-relaxed">${result.feedback || '表現優異，尚無特定回饋'}</p>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `<p class="text-rose-400 text-center font-bold">找不到該球員，請確保輸入姓名與點名表一致。</p>`;
            }
        };

        function showToast(msg) {
            const t = document.getElementById('toast');
            if (!t) return;
            t.innerText = msg;
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 3000);
        }

        // --- 渲染畫面 ---
        function renderApp() {
            const root = document.getElementById('app');
            if (viewMode === 'coach') {
                renderCoachView(root);
            } else {
                renderParentView(root);
            }
        }

        function renderCoachView(root) {
            root.innerHTML = `
                <div class="max-w-4xl mx-auto p-4 md:p-8 animate-in">
                    <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 border-b border-amber-500/20 pb-6 gap-4">
                        <div>
                            <h1 class="text-4xl font-black text-amber-500 tracking-tighter italic">TIGERS ELITE <span class="text-white">U9/U10</span></h1>
                            <p class="text-slate-500 text-xs font-bold uppercase tracking-widest mt-1">Management Interface</p>
                        </div>
                        <div class="flex gap-2 w-full md:w-auto">
                            <button onclick="switchView('parent')" class="flex-1 md:flex-none px-6 py-2 bg-slate-800 hover:bg-slate-700 rounded-xl text-sm font-bold border border-slate-700 transition">家長端查詢</button>
                            <button onclick="exportAsImage()" class="flex-1 md:flex-none px-6 py-2 bg-amber-500 hover:bg-amber-600 text-slate-950 font-black rounded-xl text-sm transition shadow-lg shadow-amber-500/20">分享報表</button>
                        </div>
                    </header>

                    <div class="mb-8 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-slate-900/50 p-6 rounded-2xl border border-slate-800">
                            <label class="block text-slate-500 text-[10px] font-black uppercase mb-2">快速新增隊員</label>
                            <div class="flex gap-2">
                                <select id="roleSelector" class="bg-slate-800 text-white px-4 py-3 rounded-xl border border-slate-700 text-sm focus:outline-none focus:border-amber-500">
                                    <option value="u9">U9 隊員</option>
                                    <option value="u10">U10 隊員</option>
                                    <option value="coach">教練組</option>
                                </select>
                                <button onclick="addMember()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-3 rounded-xl text-sm font-black flex-1 shadow-lg shadow-blue-500/20 transition">新增</button>
                            </div>
                        </div>
                        <div class="bg-slate-900/50 p-6 rounded-2xl border border-slate-800 flex items-center justify-between">
                            <div>
                                <p class="text-slate-500 text-[10px] font-black uppercase">今日出席率</p>
                                <p class="text-3xl font-black text-white">${members.length > 0 ? Math.round((members.filter(m=>m.status==='present').length / members.length)*100) : 0}%</p>
                            </div>
                            <div class="text-right">
                                <p class="text-slate-500 text-[10px] font-black uppercase">總人數</p>
                                <p class="text-3xl font-black text-amber-500">${members.length}</p>
                            </div>
                        </div>
                    </div>

                    <div id="attendanceTable" class="space-y-8">
                        ${['coach', 'u9', 'u10'].map(role => `
                            <div class="role-section">
                                <h2 class="text-[10px] font-black text-slate-600 uppercase tracking-[0.3em] mb-4 px-2 flex items-center gap-3">
                                    <span class="h-px bg-slate-800 flex-1"></span>
                                    ${role === 'coach' ? 'Coaching Staff' : role.toUpperCase() + ' SQUAD'}
                                    <span class="h-px bg-slate-800 flex-1"></span>
                                </h2>
                                <div id="list-${role}" class="grid grid-cols-1 gap-3">
                                    ${members.filter(m => m.role === role).map(m => `
                                        <div data-id="${m.id}" class="group bg-slate-900 border border-slate-800/80 p-5 rounded-2xl flex flex-col md:flex-row gap-5 items-center transition hover:border-amber-500/40 hover:shadow-xl hover:shadow-amber-500/5">
                                            <div class="flex items-center gap-4 w-full md:w-1/4">
                                                <div class="cursor-move text-slate-700 group-hover:text-amber-500/60 transition-colors p-1">
                                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M4 8h16M4 16h16"></path></svg>
                                                </div>
                                                <span class="text-lg font-black ${m.role === 'coach' ? 'text-amber-500' : 'text-slate-100'}">${m.name}</span>
                                            </div>
                                            
                                            <div class="flex gap-1 bg-slate-950 p-1.5 rounded-2xl border border-slate-800 w-full md:w-auto">
                                                <button onclick="toggleAttendance('${m.id}', 'present')" class="flex-1 px-6 py-2 rounded-xl text-[10px] font-black uppercase transition-all ${m.status === 'present' ? 'bg-emerald-500 text-emerald-950 shadow-lg shadow-emerald-500/20' : 'text-slate-600 hover:text-slate-300'}">出席</button>
                                                <button onclick="toggleAttendance('${m.id}', 'absent')" class="flex-1 px-6 py-2 rounded-xl text-[10px] font-black uppercase transition-all ${m.status === 'absent' ? 'bg-rose-500 text-rose-950 shadow-lg shadow-rose-500/20' : 'text-slate-600 hover:text-slate-300'}">缺席</button>
                                            </div>

                                            <div class="flex-1 w-full relative">
                                                <input type="text" 
                                                       placeholder="輸入今日訓練表現回饋..." 
                                                       onblur="updateFeedback('${m.id}', this.value)"
                                                       value="${m.feedback || ''}"
                                                       class="w-full bg-slate-950 border border-slate-800 rounded-2xl px-5 py-3 text-sm text-slate-200 focus:outline-none focus:border-amber-500/60 placeholder:text-slate-800 transition-all font-medium">
                                            </div>

                                            <button onclick="deleteMember('${m.id}')" class="text-slate-800 hover:text-rose-500 transition-colors p-2 hidden group-hover:block">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                            </button>
                                        </div>
                                    `).join('')}
                                    ${members.filter(m => m.role === role).length === 0 ? `<p class="text-slate-800 text-[10px] font-bold py-4 px-2 text-center border-2 border-dashed border-slate-900 rounded-2xl">NO ACTIVE MEMBERS</p>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            initSortable();
        }

        function renderParentView(root) {
            root.innerHTML = `
                <div class="max-w-md mx-auto p-6 min-h-screen flex flex-col justify-center animate-in">
                    <div class="text-center mb-12">
                        <div class="inline-block p-5 bg-gradient-to-br from-amber-400 to-amber-600 rounded-[2rem] mb-8 shadow-2xl shadow-amber-500/30 rotate-3 transition-transform hover:rotate-0 cursor-default">
                            <svg class="w-12 h-12 text-slate-950" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>
                        </div>
                        <h1 class="text-5xl font-black text-white italic tracking-tighter uppercase">Tigers <span class="text-amber-500">Elite</span></h1>
                        <p class="text-slate-500 tracking-[0.4em] text-[10px] uppercase font-black mt-3">Portal for Guardians</p>
                    </div>

                    <div class="bg-slate-900 border border-slate-800 p-10 rounded-[3rem] shadow-2xl relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-amber-500 to-transparent opacity-30"></div>
                        <label class="block text-slate-400 text-xs font-bold mb-8 text-center uppercase tracking-widest">輸入球員姓名查詢今日訓練表現</label>
                        <div class="flex flex-col gap-5">
                            <input id="parentSearchInput" type="text" placeholder="例如：林小明" 
                                   class="w-full bg-slate-950 border-2 border-slate-800 rounded-2xl px-6 py-6 text-center text-2xl text-white font-black focus:outline-none focus:border-amber-500 transition-all placeholder:text-slate-900">
                            <button onclick="searchChild()" class="w-full bg-amber-500 hover:bg-amber-400 text-slate-950 font-black py-6 rounded-2xl shadow-xl shadow-amber-500/30 transform active:scale-95 transition-all text-xl uppercase italic">
                                Check Status
                            </button>
                        </div>

                        <div id="searchResult" class="mt-10 min-h-[120px]"></div>
                    </div>

                    <div class="text-center mt-16">
                        <button onclick="switchView('coach')" class="text-slate-800 text-[10px] uppercase tracking-[0.3em] hover:text-amber-500/40 transition-colors font-black">Authorized Coach Access Only</button>
                    </div>
                </div>
            `;
        }

        function initSortable() {
            ['coach', 'u9', 'u10'].forEach(role => {
                const el = document.getElementById(`list-${role}`);
                if (!el) return;
                Sortable.create(el, {
                    animation: 250,
                    handle: '.cursor-move',
                    ghostClass: 'bg-amber-500/10',
                    onEnd: async () => {
                        const items = Array.from(el.children);
                        for (let i = 0; i < items.length; i++) {
                            const id = items[i].getAttribute('data-id');
                            if (id) {
                                try {
                                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'members', id), { order: i });
                                } catch (e) { console.error("Sort sync failed:", e); }
                            }
                        }
                    }
                });
            });
        }

        window.onload = initAuth;
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #020617; }
        .animate-in { animation: fadeIn 0.8s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        select { appearance: none; }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 antialiased selection:bg-amber-500 selection:text-slate-950">
    <div id="app">
        <!-- 身份驗證中 UI -->
        <div class="flex flex-col items-center justify-center min-h-screen">
            <div class="relative w-20 h-20 mb-8">
                <div class="absolute inset-0 border-4 border-slate-900 rounded-full"></div>
                <div class="absolute inset-0 border-4 border-amber-500 border-t-transparent rounded-full animate-spin"></div>
            </div>
            <p class="text-xs font-black uppercase tracking-[0.5em] text-slate-700 animate-pulse">Initializing Security Protocols</p>
            <p class="text-[10px] text-slate-800 mt-2">TIGERS ELITE MANAGEMENT SYSTEM v1.2</p>
        </div>
    </div>
    <!-- 提示框 -->
    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-blue-600 text-white px-10 py-5 rounded-2xl shadow-2xl hidden z-50 text-xs font-black uppercase tracking-widest animate-in"></div>
</body>
</html>