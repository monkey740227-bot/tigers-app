<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TIGERS U10 雲端查詢系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #020617; color: #f8fafc; }
        .tiger-gradient { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="pb-24 no-scrollbar">

    <div id="app">
        <!-- 頂部導航欄 -->
        <nav class="p-4 flex justify-between items-center bg-slate-950/80 sticky top-0 backdrop-blur-xl z-50 border-b border-white/5">
            <div class="flex items-center gap-2" onclick="location.reload()">
                <div class="w-9 h-9 tiger-gradient rounded-xl flex items-center justify-center shadow-lg shadow-yellow-500/20">
                    <i data-lucide="trophy" class="text-black w-5 h-5"></i>
                </div>
                <div>
                    <h1 class="text-lg font-black italic tracking-tighter uppercase leading-none">Tigers <span class="text-yellow-500">U10</span></h1>
                    <p class="text-[8px] text-slate-500 font-bold tracking-widest uppercase">Management System</p>
                </div>
            </div>
            <button id="viewToggle" class="text-[10px] font-black uppercase text-yellow-500 border border-yellow-500/30 px-4 py-1.5 rounded-full hover:bg-yellow-500/10 transition-colors">
                Coach Login
            </button>
        </nav>

        <main class="max-w-md mx-auto p-4 space-y-6">
            <!-- 家長查詢主畫面 -->
            <div id="parentView" class="space-y-6 animate-fade-in">
                <div class="bg-slate-900/40 p-8 rounded-[3rem] border border-white/5 shadow-2xl relative overflow-hidden">
                    <div class="absolute -top-4 -right-4 opacity-5">
                        <i data-lucide="search" style="width: 150px; height: 150px;"></i>
                    </div>
                    
                    <div class="relative z-10">
                        <h2 class="text-xs font-black text-yellow-400 mb-8 tracking-widest uppercase flex items-center justify-center gap-2">
                            <span class="w-1.5 h-1.5 bg-yellow-400 rounded-full animate-pulse"></span>
                            球員出缺席紀錄查詢
                        </h2>
                        
                        <div class="space-y-4">
                            <input type="text" id="searchInput" placeholder="輸入球員姓名" 
                                class="w-full bg-slate-950 border-2 border-slate-800 p-5 rounded-2xl text-center text-xl font-black focus:border-yellow-500 transition-all outline-none placeholder:text-slate-800">
                            
                            <button id="searchBtn" class="w-full tiger-gradient text-black font-black py-5 rounded-2xl active:scale-95 transition-all shadow-xl shadow-yellow-500/10">
                                搜尋資料
                            </button>
                        </div>
                    </div>

                    <!-- 搜尋結果區域 -->
                    <div id="searchResult" class="mt-8 hidden"></div>
                </div>
            </div>

            <!-- 教練管理區域 -->
            <div id="adminView" class="hidden space-y-6 animate-fade-in">
                <div class="flex justify-between items-center px-2">
                    <h2 class="text-2xl font-black italic uppercase tracking-tighter">Coach <span class="text-yellow-500">Panel</span></h2>
                    <input type="date" id="datePicker" class="bg-slate-900 text-xs p-2 rounded-xl border border-white/10 outline-none text-yellow-500 font-bold">
                </div>

                <!-- 當日評語區 -->
                <div class="bg-slate-900/80 p-4 rounded-3xl border border-white/5">
                    <p class="text-[10px] font-black text-slate-500 uppercase mb-2 ml-2">Training Notes</p>
                    <textarea id="dailyNote" placeholder="輸入今日訓練評語..." class="w-full bg-slate-950 p-4 rounded-2xl text-sm border border-slate-800 outline-none h-24 resize-none mb-3 focus:border-yellow-500 transition-all"></textarea>
                    <button id="saveNoteBtn" class="w-full py-2 bg-slate-800 rounded-xl text-[10px] font-black uppercase text-slate-400 hover:text-white transition-colors">Save Note</button>
                </div>

                <!-- 點名清單 -->
                <div id="playerRollList" class="space-y-3">
                    <!-- 動態注入 -->
                </div>

                <!-- 新增球員 -->
                <div class="p-6 border-2 border-dashed border-slate-800 rounded-[2.5rem] bg-slate-900/20">
                    <h3 class="text-[10px] font-black text-slate-500 uppercase mb-4 tracking-widest text-center">Add New Member</h3>
                    <div class="flex gap-2">
                        <input id="newName" placeholder="姓名" class="flex-1 bg-slate-950 p-4 rounded-xl text-sm border border-slate-800 outline-none">
                        <button id="addPlayerBtn" class="bg-yellow-500 text-black px-6 rounded-xl active:scale-90 transition-transform">
                            <i data-lucide="plus"></i>
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- 底部狀態欄 -->
        <footer class="fixed bottom-6 left-0 right-0 flex justify-center pointer-events-none z-50">
            <div class="bg-slate-950/90 backdrop-blur-xl border border-white/10 px-6 py-2 rounded-full shadow-2xl flex items-center gap-3">
                <div id="statusDot" class="w-2 h-2 bg-yellow-500 rounded-full animate-pulse"></div>
                <p id="syncStatus" class="text-[9px] text-slate-400 font-black uppercase tracking-[0.2em]">Initialising Cloud...</p>
            </div>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, addDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        // Firebase 配置
        const firebaseConfig = {
            apiKey: "AIzaSyAgz1BJI-PJLv3VIUfMQSmr6F-WkXzEMzU",
            authDomain: "mei-yu-u10.firebaseapp.com",
            projectId: "mei-yu-u10",
            storageBucket: "mei-yu-u10.firebasestorage.app",
            messagingSenderId: "157433419856",
            appId: "1:157433419856:web:07db1e6968990d5719d955"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = "tigers-u10-main"; // 固定路徑

        let players = [];
        let dailyRecords = {};
        let currentView = 'parent';
        let selectedDate = new Date().toISOString().split('T')[0];

        // 初始化系統
        async function init() {
            try {
                await signInAnonymously(auth);
                document.getElementById('syncStatus').innerText = "Tigers Cloud: Connected";
                document.getElementById('statusDot').classList.replace('bg-yellow-500', 'bg-green-500');
                lucide.createIcons();
                document.getElementById('datePicker').value = selectedDate;

                // 實時監聽球員名單
                onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'members'), orderBy('name')), (snap) => {
                    players = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    if(currentView === 'admin') renderAdminList();
                });

                // 實時監聽點名紀錄
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'daily'), (snap) => {
                    snap.docs.forEach(d => { dailyRecords[d.id] = d.data(); });
                    if(currentView === 'admin') renderAdminList();
                });
            } catch (err) {
                document.getElementById('syncStatus').innerText = "Cloud Error: Auth Failed";
                document.getElementById('statusDot').classList.replace('bg-yellow-500', 'bg-red-500');
            }
        }

        // 搜尋邏輯 (去空格 + 模糊搜尋)
        document.getElementById('searchBtn').onclick = () => {
            const raw = document.getElementById('searchInput').value;
            const term = raw.replace(/\s+/g, "").toLowerCase();
            const resDiv = document.getElementById('searchResult');
            
            if (!term) return;
            resDiv.classList.remove('hidden');

            const p = players.find(x => x.name.replace(/\s+/g, "").toLowerCase().includes(term));

            if (!p) {
                resDiv.innerHTML = `
                    <div class="p-4 bg-red-500/10 text-red-400 text-xs rounded-2xl border border-red-500/20 animate-fade-in">
                        找不到球員「${raw}」，請檢查姓名。
                    </div>
                `;
                return;
            }

            // 計算出勤率
            let present = 0, total = 0;
            const records = Object.entries(dailyRecords)
                .filter(([date, d]) => d.roll?.[p.id] && d.roll[p.id] !== 0)
                .sort((a,b) => b[0].localeCompare(a[0]));

            records.forEach(([date, d]) => {
                total++;
                if (d.roll[p.id] === 1) present++;
            });

            const rate = total > 0 ? Math.round((present/total)*100) : 0;

            resDiv.innerHTML = `
                <div class="bg-slate-950 p-6 rounded-[2rem] border border-yellow-500/30 text-left animate-fade-in shadow-2xl">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <span class="text-[9px] bg-yellow-500 text-black px-2 py-0.5 rounded font-black italic uppercase">Tigers Member</span>
                            <h3 class="text-3xl font-black mt-1">${p.name}</h3>
                        </div>
                        <div class="text-right">
                            <div class="text-4xl font-black text-yellow-500">${rate}%</div>
                            <div class="text-[8px] text-slate-500 font-black uppercase">Attendance Rate</div>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest border-b border-white/5 pb-2">Recent Performance</p>
                        ${records.slice(0, 5).map(([date, d]) => `
                            <div class="p-3 bg-slate-900/50 rounded-xl border border-white/5">
                                <div class="flex justify-between items-center">
                                    <span class="text-xs font-bold text-slate-400">${date}</span>
                                    <span class="text-[10px] font-black uppercase italic ${d.roll[p.id] === 1 ? 'text-green-500' : 'text-red-500'}">
                                        ${d.roll[p.id] === 1 ? 'Present 出席' : 'Absent 缺席'}
                                    </span>
                                </div>
                                ${d.note ? `<p class="text-[11px] text-slate-400 mt-2 border-l-2 border-yellow-500/50 pl-2 italic leading-relaxed">${d.note}</p>` : ''}
                            </div>
                        `).join('') || '<div class="text-center py-4 text-xs text-slate-700 italic">尚無點名紀錄</div>'}
                    </div>
                </div>
            `;
        };

        // 教練模式渲染清單
        function renderAdminList() {
            const list = document.getElementById('playerRollList');
            const currentRoll = dailyRecords[selectedDate]?.roll || {};
            document.getElementById('dailyNote').value = dailyRecords[selectedDate]?.note || "";

            list.innerHTML = players.map(p => {
                const s = currentRoll[p.id] || 0;
                return `
                    <div class="bg-slate-900/60 p-4 rounded-2xl flex justify-between items-center border border-white/5">
                        <span class="font-bold text-lg">${p.name}</span>
                        <div class="flex gap-2">
                            <button onclick="window.setRoll('${p.id}', 1)" class="w-12 h-12 rounded-xl ${s === 1 ? 'bg-green-600 shadow-lg shadow-green-600/30' : 'bg-slate-950 text-slate-700'} font-black transition-all">出</button>
                            <button onclick="window.setRoll('${p.id}', 2)" class="w-12 h-12 rounded-xl ${s === 2 ? 'bg-red-600 shadow-lg shadow-red-600/30' : 'bg-slate-950 text-slate-700'} font-black transition-all">缺</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 修改點名狀態
        window.setRoll = async (pid, status) => {
            const roll = dailyRecords[selectedDate]?.roll || {};
            roll[pid] = roll[pid] === status ? 0 : status;
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'daily', selectedDate), { roll, updatedAt: Date.now() }, { merge: true });
        };

        // 切換視圖
        document.getElementById('viewToggle').onclick = () => {
            if (currentView === 'parent') {
                const p = prompt("請輸入教練登入密碼:");
                if (p === "0227") {
                    currentView = 'admin';
                    document.getElementById('parentView').classList.add('hidden');
                    document.getElementById('adminView').classList.remove('hidden');
                    document.getElementById('viewToggle').innerText = "Logout";
                    renderAdminList();
                }
            } else { location.reload(); }
        };

        // 儲存評語
        document.getElementById('saveNoteBtn').onclick = async () => {
            const note = document.getElementById('dailyNote').value;
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'daily', selectedDate), { note }, { merge: true });
            alert("評語已儲存，家長現在可以看到今日的訓練筆記！");
        };

        document.getElementById('datePicker').onchange = (e) => {
            selectedDate = e.target.value;
            renderAdminList();
        };

        document.getElementById('addPlayerBtn').onclick = async () => {
            const name = document.getElementById('newName').value.trim();
            if (!name) return;
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'members'), { name, createdAt: Date.now() });
            document.getElementById('newName').value = '';
        };

        init();
    </script>
</body>
</html>
