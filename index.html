<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>美育虎U10 - 終極診斷</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: white; font-family: sans-serif; }
        .debug-log { background: #000; color: #0f0; font-family: monospace; font-size: 10px; padding: 10px; height: 150px; overflow-y: auto; border-top: 2px solid #333; position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000; }
    </style>
</head>
<body class="pb-40">

    <!-- 轉圈圈遮罩 -->
    <div id="loader" class="fixed inset-0 bg-slate-900 z-[999] flex flex-col items-center justify-center p-10 text-center">
        <div class="w-12 h-12 border-4 border-yellow-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <h2 class="text-xl font-bold text-yellow-500">系統診斷中...</h2>
        <p class="text-slate-500 text-xs mt-2">如果超過 10 秒沒反應，請看下方綠色文字報錯</p>
        <button onclick="forceShow()" class="mt-8 px-6 py-2 bg-slate-800 rounded-full text-xs">強制進入介面 (僅限測試)</button>
    </div>

    <!-- 主介面 -->
    <div id="app" class="hidden p-4">
        <header class="flex justify-between items-center mb-6">
            <h1 onclick="requestAdmin()" class="text-2xl font-black italic text-yellow-500">TIGERS U10</h1>
            <div id="cloud-indicator" class="text-[10px] bg-red-900 px-2 py-1 rounded">OFFLINE</div>
        </header>

        <div id="parent-zone" class="space-y-4">
            <div class="bg-slate-800 p-6 rounded-3xl text-center">
                <input type="text" id="search-input" placeholder="輸入球員姓名" class="w-full bg-slate-950 p-4 rounded-xl text-center text-xl mb-4 outline-none border border-slate-700">
                <button onclick="handleSearch()" class="w-full bg-yellow-500 text-black py-4 rounded-xl font-bold">查詢紀錄</button>
                <div id="result-area" class="mt-6 text-left"></div>
            </div>
        </div>

        <div id="coach-zone" class="hidden space-y-4">
            <div class="bg-slate-800 p-4 rounded-xl">
                <div class="flex justify-between mb-4">
                    <input type="date" id="target-date" class="bg-slate-950 p-2 rounded text-sm">
                    <button onclick="saveData()" class="bg-blue-600 px-4 py-2 rounded text-sm font-bold">同步存檔</button>
                </div>
                <div id="member-list" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <!-- 螢幕 log 視窗 -->
    <div id="debug" class="debug-log">
        <div>[SYSTEM] 初始化診斷開始...</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const log = (msg, color = "#0f0") => {
            const div = document.createElement('div');
            div.style.color = color;
            div.innerText = `> ${msg}`;
            const container = document.getElementById('debug');
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        };

        window.onerror = (e) => log("JS Error: " + e, "#f00");

        const firebaseConfig = {
            apiKey: "AIzaSyAgz1BJI-PJLv3VIUfMQSmr6F-WkXzEMzU",
            authDomain: "mei-yu-u10.firebaseapp.com",
            projectId: "mei-yu-u10",
            storageBucket: "mei-yu-u10.firebasestorage.app",
            messagingSenderId: "157433419856",
            appId: "1:157433419856:web:07db1e6968990d5719d955"
        };

        let db, auth, players = [], currentRoll = {};

        async function init() {
            try {
                log("正在連線 Firebase...");
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                log("Firebase 模組載入成功");

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        log("身份驗證成功: " + user.uid);
                        document.getElementById('cloud-indicator').innerText = "ONLINE";
                        document.getElementById('cloud-indicator').className = "text-[10px] bg-green-600 px-2 py-1 rounded";
                        setupApp();
                    } else {
                        log("嘗試匿名登入...");
                        signInAnonymously(auth).catch(e => {
                            log("登入失敗: " + e.code, "#f00");
                            log("請確認 Firebase 匿名登入已開啟", "#f00");
                        });
                    }
                });

            } catch (e) {
                log("初始化崩潰: " + e.message, "#f00");
            }
        }

        function setupApp() {
            log("開始讀取球員名單...");
            // 使用最簡單的集合路徑進行測試
            onSnapshot(collection(db, "members"), (snap) => {
                players = snap.docs.map(d => ({id: d.id, ...d.data()}));
                log(`成功獲取 ${players.length} 名球員`);
                document.getElementById('loader').style.display = 'none';
                document.getElementById('app').classList.remove('hidden');
            }, (err) => {
                log("讀取資料庫失敗: " + err.message, "#f00");
                log("請確認 Firestore Rules 已發布且允許讀取", "#f00");
            });
        }

        window.forceShow = () => {
            log("強制跳過連線，顯示介面...");
            document.getElementById('loader').style.display = 'none';
            document.getElementById('app').classList.remove('hidden');
        };

        window.requestAdmin = () => {
            const p = prompt("密碼");
            if(p === "0227") {
                document.getElementById('coach-zone').classList.remove('hidden');
                log("已進入教練模式");
            }
        };

        window.handleSearch = () => {
            const name = document.getElementById('search-input').value;
            log("查詢姓名: " + name);
            // 邏輯省略...
        };

        init();
    </script>
</body>
</html>