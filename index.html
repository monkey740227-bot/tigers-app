import React, { useState, useRef, useEffect } from 'react';
import { 
  Users, 
  UserCheck, 
  Activity, 
  Camera, 
  Plus, 
  Trash2, 
  Edit2, 
  Save, 
  ChevronDown, 
  ChevronUp,
  Download
} from 'lucide-react';

// 初始模擬數據
const INITIAL_DATA = {
  u9: [
    { id: 'u9-1', name: '小明', attendance: 'present', trainingStatus: '良好', note: '盤球進步明顯' },
    { id: 'u9-2', name: '小華', attendance: 'absent', trainingStatus: '普通', note: '請感冒假' },
  ],
  u10: [
    { id: 'u10-1', name: '大強', attendance: 'present', trainingStatus: '優秀', note: '射門精準度極高' },
  ],
  coaches: [
    { id: 'c1', name: '王教練', role: '總教練', status: '在場' },
    { id: 'c2', name: '李教練', role: '助理教練', status: '在場' },
  ]
};

const App = () => {
  const [data, setData] = useState(INITIAL_DATA);
  const [activeTab, setActiveTab] = useState('attendance');
  const [isCapturing, setIsCapturing] = useState(false);
  const captureRef = useRef(null);

  // 動態載入 html2canvas
  useEffect(() => {
    const script = document.createElement('script');
    script.src = "https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js";
    script.async = true;
    document.body.appendChild(script);
    return () => {
      document.body.removeChild(script);
    };
  }, []);

  // --- 功能函式 ---

  // 截圖功能 (修正版)
  const handleCapture = async () => {
    if (!captureRef.current || !window.html2canvas) {
      console.error("html2canvas 未載入");
      return;
    }
    
    setIsCapturing(true);
    // 延遲以確保 UI 狀態更新（隱藏按鈕等）
    setTimeout(async () => {
      try {
        const canvas = await window.html2canvas(captureRef.current, {
          backgroundColor: '#f8fafc',
          scale: 2,
          useCORS: true,
          logging: false,
        });
        const image = canvas.toDataURL("image/png");
        const link = document.createElement('a');
        link.href = image;
        link.download = `足球隊點名回報_${new Date().toISOString().split('T')[0]}.png`;
        link.click();
      } catch (err) {
        console.error("截圖失敗:", err);
      } finally {
        setIsCapturing(false);
      }
    }, 200);
  };

  // 變更出缺席
  const toggleAttendance = (category, id) => {
    const newData = { ...data };
    const index = newData[category].findIndex(p => p.id === id);
    const current = newData[category][index].attendance;
    // 循環切換：出席 -> 缺席 -> 遲到 -> 出席
    const nextStatus = current === 'present' ? 'absent' : (current === 'absent' ? 'late' : 'present');
    newData[category][index].attendance = nextStatus;
    setData(newData);
  };

  // 更新訓練狀況
  const updateTraining = (category, id, field, value) => {
    const newData = { ...data };
    const index = newData[category].findIndex(p => p.id === id);
    newData[category][index][field] = value;
    setData(newData);
  };

  // 人員編輯
  const addPerson = (category) => {
    const name = prompt("請輸入姓名:");
    if (!name) return;
    const newData = { ...data };
    const newItem = category === 'coaches' 
      ? { id: `c-${Date.now()}`, name, role: '教練', status: '在場' }
      : { id: `${category}-${Date.now()}`, name, attendance: 'present', trainingStatus: '普通', note: '' };
    newData[category].push(newItem);
    setData(newData);
  };

  const removePerson = (category, id) => {
    if (!confirm("確定要刪除此人員嗎？")) return;
    const newData = { ...data };
    newData[category] = newData[category].filter(p => p.id !== id);
    setData(newData);
  };

  // --- 子組件 ---

  const AttendanceView = () => (
    <div ref={captureRef} className="p-4 space-y-6 bg-slate-50 min-h-screen">
      <div className="flex justify-between items-center mb-2">
        <div>
          <h2 className="text-2xl font-bold text-slate-800">點名與出缺席</h2>
          <p className="text-sm text-slate-500">{new Date().toLocaleDateString()} 訓練課程</p>
        </div>
        {!isCapturing && (
          <button 
            onClick={handleCapture}
            className="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition shadow-md active:scale-95"
          >
            <Camera size={18} /> 截圖回報
          </button>
        )}
      </div>

      {['u9', 'u10', 'coaches'].map(cat => (
        <div key={cat} className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
          <div className="bg-slate-800 text-white px-4 py-2 flex justify-between items-center">
            <span className="font-bold uppercase tracking-wider">
              {cat === 'u9' ? 'U9 梯隊' : cat === 'u10' ? 'U10 梯隊' : '教練團'}
            </span>
            <span className="text-xs bg-slate-700 px-2 py-1 rounded">人數: {data[cat].length}</span>
          </div>
          <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 p-4">
            {data[cat].map(person => (
              <div 
                key={person.id}
                onClick={() => cat !== 'coaches' && toggleAttendance(cat, person.id)}
                className={`p-3 rounded-lg border-2 text-center transition-all duration-200 ${
                  cat === 'coaches' ? 'border-slate-200 bg-slate-50 cursor-default' :
                  person.attendance === 'present' ? 'border-green-500 bg-green-50 text-green-700' :
                  person.attendance === 'late' ? 'border-yellow-500 bg-yellow-100 text-yellow-700' :
                  'border-red-400 bg-red-50 text-red-600'
                } ${cat !== 'coaches' ? 'cursor-pointer hover:scale-105 active:scale-95' : ''}`}
              >
                <div className="font-bold text-base truncate">{person.name}</div>
                <div className="text-[10px] mt-1 font-medium">
                  {cat === 'coaches' ? person.role : 
                   (person.attendance === 'present' ? '✓ 出席' : 
                    person.attendance === 'late' ? '△ 遲到' : '✕ 缺席')}
                </div>
              </div>
            ))}
          </div>
        </div>
      ))}
      
      {isCapturing && (
        <div className="text-center py-4 border-t border-dashed border-slate-300">
          <p className="text-slate-400 text-xs italic">基石足球青訓管理系統 - 自動生成回報單</p>
        </div>
      )}
    </div>
  );

  const TrainingView = () => (
    <div className="p-4 space-y-6 animate-in fade-in slide-in-from-bottom-4">
      <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2">
        <Activity className="text-blue-600" /> 個人訓練評核
      </h2>
      {['u9', 'u10'].map(cat => (
        <div key={cat} className="space-y-4">
          <div className="flex items-center gap-2">
            <div className="h-6 w-1 bg-blue-500 rounded-full"></div>
            <h3 className="text-lg font-bold text-slate-700 uppercase">{cat} 隊員清單</h3>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {data[cat].map(person => (
              <div key={person.id} className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-shadow">
                <div className="flex justify-between items-center mb-3">
                  <span className="font-bold text-lg text-slate-800">{person.name}</span>
                  <div className="flex items-center gap-2">
                    <span className="text-xs text-slate-400">訓練表現:</span>
                    <select 
                      value={person.trainingStatus}
                      onChange={(e) => updateTraining(cat, person.id, 'trainingStatus', e.target.value)}
                      className="bg-blue-50 text-blue-700 border-none rounded-lg px-2 py-1 text-sm font-bold outline-none focus:ring-2 focus:ring-blue-400 cursor-pointer"
                    >
                      <option value="優秀">優秀 ★★★</option>
                      <option value="良好">良好 ★★</option>
                      <option value="普通">普通 ★</option>
                      <option value="待加強">待加強 ⚠</option>
                      <option value="受傷恢復中">傷退/復健</option>
                    </select>
                  </div>
                </div>
                <div className="relative">
                  <textarea 
                    placeholder="點擊輸入訓練觀察評語（如：盤球重心控制、傳球時機...）"
                    className="w-full text-sm p-3 bg-slate-50 rounded-lg border border-slate-100 h-24 resize-none focus:bg-white focus:border-blue-200 focus:ring-0 transition-all"
                    value={person.note}
                    onChange={(e) => updateTraining(cat, person.id, 'note', e.target.value)}
                  />
                  <div className="absolute bottom-2 right-2 text-[10px] text-slate-300 italic">Auto-saving...</div>
                </div>
              </div>
            ))}
          </div>
        </div>
      ))}
    </div>
  );

  const ManagementView = () => (
    <div className="p-4 space-y-6 animate-in fade-in">
      <div className="flex justify-between items-center">
        <h2 className="text-2xl font-bold text-slate-800">核心成員管理</h2>
      </div>

      {['u9', 'u10', 'coaches'].map(cat => (
        <div key={cat} className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
          <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
            <h3 className="font-bold text-slate-700 uppercase">
              {cat === 'u9' ? 'U9 梯隊' : cat === 'u10' ? 'U10 梯隊' : '教練團'}
            </h3>
            <button 
              onClick={() => addPerson(cat)}
              className="flex items-center gap-1 bg-blue-600 text-white px-3 py-1.5 rounded-lg text-sm font-medium hover:bg-blue-700 transition"
            >
              <Plus size={16} /> 新增
            </button>
          </div>
          <div className="overflow-x-auto">
            <table className="w-full text-left">
              <thead>
                <tr className="text-slate-400 text-xs border-b border-slate-50">
                  <th className="px-4 py-3 font-semibold uppercase">姓名</th>
                  <th className="px-4 py-3 font-semibold uppercase">{cat === 'coaches' ? '職級' : '類型'}</th>
                  <th className="px-4 py-3 font-semibold uppercase text-right">管理</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-slate-50">
                {data[cat].map(person => (
                  <tr key={person.id} className="hover:bg-slate-50 transition-colors">
                    <td className="px-4 py-3 font-bold text-slate-700">{person.name}</td>
                    <td className="px-4 py-3">
                      <span className="text-xs bg-slate-100 px-2 py-0.5 rounded text-slate-500">
                        {cat === 'coaches' ? person.role : '一般學員'}
                      </span>
                    </td>
                    <td className="px-4 py-3 text-right">
                      <button 
                        onClick={() => removePerson(cat, person.id)}
                        className="text-slate-300 hover:text-red-500 transition p-1"
                        title="刪除"
                      >
                        <Trash2 size={16} />
                      </button>
                    </td>
                  </tr>
                ))}
                {data[cat].length === 0 && (
                  <tr>
                    <td colSpan="3" className="px-4 py-8 text-center text-slate-400 text-sm">目前無人員資料</td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </div>
      ))}
    </div>
  );

  return (
    <div className="max-w-4xl mx-auto bg-slate-50 min-h-screen relative shadow-2xl">
      {/* 頂部導航 */}
      <nav className="sticky top-0 z-20 bg-white/95 backdrop-blur-md border-b border-slate-200 px-4 py-3 flex justify-around items-center shadow-sm">
        <button 
          onClick={() => setActiveTab('attendance')}
          className={`flex flex-col items-center gap-1 flex-1 py-1 rounded-lg transition-all ${activeTab === 'attendance' ? 'text-blue-600 bg-blue-50' : 'text-slate-400 hover:bg-slate-50'}`}
        >
          <UserCheck size={22} />
          <span className="text-[10px] font-bold">點名回報</span>
        </button>
        <button 
          onClick={() => setActiveTab('training')}
          className={`flex flex-col items-center gap-1 flex-1 py-1 rounded-lg transition-all ${activeTab === 'training' ? 'text-blue-600 bg-blue-50' : 'text-slate-400 hover:bg-slate-50'}`}
        >
          <Activity size={22} />
          <span className="text-[10px] font-bold">訓練表現</span>
        </button>
        <button 
          onClick={() => setActiveTab('management')}
          className={`flex flex-col items-center gap-1 flex-1 py-1 rounded-lg transition-all ${activeTab === 'management' ? 'text-blue-600 bg-blue-50' : 'text-slate-400 hover:bg-slate-50'}`}
        >
          <Users size={22} />
          <span className="text-[10px] font-bold">名單編輯</span>
        </button>
      </nav>

      {/* 內容區域 */}
      <main className="pb-24">
        {activeTab === 'attendance' && <AttendanceView />}
        {activeTab === 'training' && <TrainingView />}
        {activeTab === 'management' && <ManagementView />}
      </main>

      {/* 快速導出 FAB (只在點名頁顯示) */}
      {activeTab === 'attendance' && !isCapturing && (
        <div className="fixed bottom-6 right-6 z-30">
          <button 
            onClick={handleCapture}
            className="bg-blue-600 text-white p-4 rounded-full shadow-lg hover:bg-blue-700 hover:scale-110 active:scale-95 transition-all flex items-center justify-center group"
          >
            <Download size={24} />
            <span className="max-w-0 overflow-hidden group-hover:max-w-xs group-hover:ml-2 transition-all duration-300 text-sm font-bold whitespace-nowrap">
              導出回報圖
            </span>
          </button>
        </div>
      )}
    </div>
  );
};

export default App;
