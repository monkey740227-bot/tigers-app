<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>美育虎 - 數據分析與報表系統</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- 引入截圖函式庫 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #020617; color: #f1f5f9; -webkit-tap-highlight-color: transparent; }
        .tiger-gradient { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
        .report-preview { background-color: #020617; width: 100%; max-width: 500px; margin: 0 auto; padding: 40px 20px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const firebase = window.firebase;
        const { useState, useEffect, useMemo, useRef } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyAgz1BJI-PJLv3VIUfMQSmr6F-WkXzEMzU",
            authDomain: "mei-yu-u10.firebaseapp.com",
            projectId: "mei-yu-u10",
            storageBucket: "mei-yu-u10.firebasestorage.app",
            messagingSenderId: "157433419856",
            appId: "1:157433419856:web:07db1e6968990d5719d955"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const appId = "tigers-u10";

        // 獨立出的評語輸入組件
        function CommentInput({ pId, initialValue, onSave }) {
            const [localValue, setLocalValue] = useState(initialValue);
            useEffect(() => { setLocalValue(initialValue); }, [initialValue]);
            const handleBlur = () => { if (localValue !== initialValue) onSave(pId, localValue); };
            return (
                <input 
                    type="text" 
                    placeholder="輸入表現建議..." 
                    value={localValue || ""}
                    onChange={(e) => setLocalValue(e.target.value)}
                    onBlur={handleBlur}
                    className="w-full bg-slate-950/50 border border-white/5 rounded-xl px-3 py-2 text-xs focus:border-yellow-500 outline-none"
                />
            );
        }

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('parent'); 
            const [players, setPlayers] = useState([]);
            const [dailyRecords, setDailyRecords] = useState({});
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            const [loading, setLoading] = useState(true);
            const [activeGroup, setActiveGroup] = useState('U10');
            const [searchName, setSearchName] = useState('');
            const [searchResult, setSearchResult] = useState(null);
            const [isCapturing, setIsCapturing] = useState(false);

            const reportRef = useRef(null);

            useEffect(() => {
                auth.signInAnonymously().catch(console.error);
                return auth.onAuthStateChanged(u => { setUser(u); if (u) setLoading(false); });
            }, []);

            useEffect(() => {
                if (!user) return;
                const unsubPlayers = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('members')
                    .orderBy('order', 'asc')
                    .onSnapshot(snap => setPlayers(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
                
                const unsubDaily = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('daily')
                    .onSnapshot(snap => {
                        const data = {};
                        snap.docs.forEach(d => { data[d.id] = d.data(); });
                        setDailyRecords(data);
                    });
                return () => { unsubPlayers(); unsubDaily(); };
            }, [user]);

            const stats = useMemo(() => {
                const result = {};
                players.forEach(p => { result[p.id] = { attend: 0, absent: 0, comments: [] }; });
                Object.entries(dailyRecords).forEach(([date, data]) => {
                    if (data.roll) {
                        Object.entries(data.roll).forEach(([pId, status]) => {
                            if (result[pId]) {
                                if (status === 1) result[pId].attend++;
                                if (status === 2) result[pId].absent++;
                            }
                        });
                    }
                    if (data.playerComments) {
                        Object.entries(data.playerComments).forEach(([pId, comment]) => {
                            if (result[pId] && comment) result[pId].comments.push({ date, text: comment });
                        });
                    }
                });
                return result;
            }, [dailyRecords, players]);

            const currentPlayers = useMemo(() => players.filter(p => p.group === activeGroup), [players, activeGroup]);
            const attendanceSummary = useMemo(() => {
                const roll = dailyRecords[selectedDate]?.roll || {};
                const list = currentPlayers.map(p => ({ ...p, status: roll[p.id] || 0 }));
                return {
                    present: list.filter(p => p.status === 1),
                    absent: list.filter(p => p.status === 2),
                    total: list.length
                };
            }, [currentPlayers, dailyRecords, selectedDate]);

            const updateDaily = async (key, value) => {
                const ref = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('daily').doc(selectedDate);
                await ref.set({ [key]: value, updatedAt: Date.now() }, { merge: true });
            };

            const toggleStatus = (pId, status) => {
                const currentRoll = dailyRecords[selectedDate]?.roll || {};
                const newStatus = currentRoll[pId] === status ? 0 : status;
                updateDaily('roll', { ...currentRoll, [pId]: newStatus });
            };

            const updatePlayerComment = (pId, text) => {
                const currentComments = dailyRecords[selectedDate]?.playerComments || {};
                updateDaily('playerComments', { ...currentComments, [pId]: text });
            };

            // 截圖核心功能
            const captureReport = async () => {
                setIsCapturing(true);
                // 等待 React 渲染完成
                setTimeout(async () => {
                    const canvas = await html2canvas(reportRef.current, {
                        backgroundColor: '#020617',
                        scale: 2, // 提高解析度
                        logging: false,
                        useCORS: true
                    });
                    const link = document.createElement('a');
                    link.download = `美育虎訓練報表_${selectedDate}_${activeGroup}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    setIsCapturing(false);
                }, 500);
            };

            if (loading) return <div className="h-screen flex items-center justify-center text-yellow-500 font-black italic animate-pulse">TIGERS LOADING...</div>;

            return (
                <div className="min-h-screen pb-24">
                    <header className="sticky top-0 z-40 bg-slate-950/90 backdrop-blur-lg p-4 flex justify-between items-center border-b border-white/5">
                        <div className="flex items-center gap-2" onClick={() => setView('parent')}>
                            <div className="bg-yellow-500 text-black w-7 h-7 flex items-center justify-center rounded font-black italic text-xs">T</div>
                            <span className="font-black italic text-lg tracking-tighter uppercase">Meiyu <span className="text-yellow-500">Tigers</span></span>
                        </div>
                        <button onClick={() => {
                            if (view === 'parent') {
                                const p = prompt("教練認證"); if (p === "0227") setView('coach');
                            } else setView('parent');
                        }} className="bg-slate-900 border border-white/10 px-4 py-1.5 rounded-full text-[10px] font-black uppercase">
                            {view === 'parent' ? "Coach Login" : "Logout"}
                        </button>
                    </header>

                    <nav className="p-4 flex gap-2 sticky top-[61px] z-30 bg-slate-950/80 backdrop-blur-md border-b border-white/5 overflow-x-auto no-scrollbar">
                        {['U9', 'U10', '教練團'].map(g => (
                            <button key={g} onClick={() => setActiveGroup(g)}
                                className={`px-6 py-2 rounded-full text-xs font-black italic transition-all whitespace-nowrap ${activeGroup === g ? 'bg-yellow-500 text-black' : 'bg-slate-900 text-slate-500'}`}
                            >{g}</button>
                        ))}
                    </nav>

                    <main className="max-w-md mx-auto p-4">
                        {view === 'parent' ? (
                            <div className="space-y-6">
                                <div className="tiger-gradient p-8 rounded-[2.5rem] text-center border border-white/5 shadow-2xl">
                                    <h2 className="text-xl font-black mb-6 italic tracking-widest uppercase text-yellow-500">Player Profile</h2>
                                    <input type="text" placeholder="輸入球員姓名" value={searchName} onChange={e => setSearchName(e.target.value)}
                                        className="w-full bg-slate-950 p-4 rounded-2xl text-center text-xl font-bold border border-slate-800 mb-4 outline-none focus:border-yellow-500" />
                                    <button onClick={() => setSearchResult(players.find(p => p.name === searchName))}
                                        className="w-full bg-yellow-500 text-black font-black py-4 rounded-2xl active:scale-95 transition-all">搜尋數據</button>
                                </div>
                                {searchResult && (
                                    <div className="bg-slate-900 rounded-[2.5rem] p-6 border border-yellow-500/20 shadow-xl animate-in slide-in-from-bottom-4">
                                        <div className="flex justify-between items-center mb-6">
                                            <div>
                                                <div className="text-yellow-500 font-black italic text-sm">#{searchResult.number}</div>
                                                <h3 className="text-3xl font-black">{searchResult.name}</h3>
                                            </div>
                                            <div className="text-right">
                                                <div className="text-[10px] text-slate-500 font-bold uppercase italic">Attend Rate</div>
                                                <div className="text-2xl font-black text-yellow-500">
                                                    {Math.round((stats[searchResult.id]?.attend / (stats[searchResult.id]?.attend + stats[searchResult.id]?.absent || 1)) * 100)}%
                                                </div>
                                            </div>
                                        </div>
                                        <div className="space-y-4">
                                            <h4 className="text-[10px] font-black text-slate-500 uppercase tracking-widest border-b border-white/5 pb-2 italic">Coach Feedback</h4>
                                            {stats[searchResult.id]?.comments.length > 0 ? (
                                                stats[searchResult.id].comments.slice().reverse().map((c, i) => (
                                                    <div key={i} className="bg-slate-950 p-4 rounded-2xl border border-white/5">
                                                        <div className="text-[10px] text-yellow-500 font-bold mb-1 italic">{c.date}</div>
                                                        <p className="text-sm leading-relaxed text-slate-300">{c.text}</p>
                                                    </div>
                                                ))
                                            ) : <p className="text-center text-slate-600 py-8 text-xs italic">尚未有評語紀錄</p>}
                                        </div>
                                    </div>
                                )}
                            </div>
                        ) : (
                            <div className="space-y-4">
                                <div className="bg-slate-900 p-5 rounded-3xl border border-white/5 flex justify-between items-center shadow-lg">
                                    <input type="date" className="bg-slate-950 p-2 rounded-xl text-xs font-bold text-yellow-500 outline-none" value={selectedDate} onChange={e => setSelectedDate(e.target.value)} />
                                    <div className="flex gap-2">
                                        <button onClick={captureReport} className="bg-blue-600 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase flex items-center gap-2 shadow-lg shadow-blue-900/30">
                                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                                            截圖報表
                                        </button>
                                    </div>
                                </div>

                                {/* 點名列表 */}
                                <div className="space-y-3">
                                    {currentPlayers.map(p => {
                                        const status = dailyRecords[selectedDate]?.roll?.[p.id] || 0;
                                        return (
                                            <div key={p.id} className="bg-slate-900 rounded-2xl border border-white/5 overflow-hidden transition-all hover:border-white/10">
                                                <div className="p-4 flex justify-between items-center">
                                                    <div className="flex items-center gap-3">
                                                        <div className="w-8 h-8 bg-slate-950 rounded-full flex items-center justify-center font-black text-yellow-500 italic text-xs">#{p.number}</div>
                                                        <span className="font-bold">{p.name}</span>
                                                    </div>
                                                    <div className="flex gap-1">
                                                        <button onClick={() => toggleStatus(p.id, 1)} className={`px-4 py-2 rounded-lg text-xs font-black transition-all ${status === 1 ? 'bg-green-600 text-white shadow-lg' : 'bg-slate-950 text-slate-700'}`}>出</button>
                                                        <button onClick={() => toggleStatus(p.id, 2)} className={`px-4 py-2 rounded-lg text-xs font-black transition-all ${status === 2 ? 'bg-red-600 text-white shadow-lg' : 'bg-slate-950 text-slate-700'}`}>缺</button>
                                                    </div>
                                                </div>
                                                <div className="px-4 pb-4">
                                                    <CommentInput 
                                                        pId={p.id}
                                                        initialValue={dailyRecords[selectedDate]?.playerComments?.[p.id] || ""}
                                                        onSave={updatePlayerComment}
                                                    />
                                                </div>
                                            </div>
                                        )
                                    })}
                                </div>
                            </div>
                        )}
                    </main>

                    {/* 隱藏的截圖專用渲染區 (隱藏但在 DOM 中，讓 html2canvas 抓取) */}
                    <div style={{ position: 'absolute', left: '-9999px', top: 0 }}>
                        <div ref={reportRef} className="report-preview text-slate-100">
                            <div className="text-center mb-10">
                                <div className="inline-block bg-yellow-500 text-black px-3 py-1 rounded font-black italic text-xs mb-2">TIGERS REPORT</div>
                                <h1 className="text-3xl font-black italic tracking-tighter uppercase leading-none">Meiyu <span className="text-yellow-500">Tigers</span></h1>
                                <p className="text-slate-500 text-xs mt-2 font-bold tracking-[0.2em]">{selectedDate} 訓練日報 - {activeGroup}</p>
                            </div>

                            <div className="flex justify-around mb-10 gap-4">
                                <div className="bg-slate-900/50 p-4 rounded-2xl flex-1 text-center border border-white/5">
                                    <div className="text-[10px] text-slate-500 font-bold uppercase mb-1">出席</div>
                                    <div className="text-2xl font-black text-green-500 italic">{attendanceSummary.present.length}</div>
                                </div>
                                <div className="bg-slate-900/50 p-4 rounded-2xl flex-1 text-center border border-white/5">
                                    <div className="text-[10px] text-slate-500 font-bold uppercase mb-1">缺席</div>
                                    <div className="text-2xl font-black text-red-500 italic">{attendanceSummary.absent.length}</div>
                                </div>
                                <div className="bg-slate-900/50 p-4 rounded-2xl flex-1 text-center border border-white/5">
                                    <div className="text-[10px] text-slate-500 font-bold uppercase mb-1">總人數</div>
                                    <div className="text-2xl font-black text-yellow-500 italic">{attendanceSummary.total}</div>
                                </div>
                            </div>

                            <div className="space-y-6">
                                <h3 className="text-[10px] font-black text-yellow-500 uppercase tracking-widest border-b border-yellow-500/30 pb-2">表現建議清單</h3>
                                {currentPlayers.map(p => {
                                    const comment = dailyRecords[selectedDate]?.playerComments?.[p.id];
                                    const status = dailyRecords[selectedDate]?.roll?.[p.id];
                                    if (!comment && status !== 1) return null;
                                    return (
                                        <div key={p.id} className="border-b border-white/5 pb-4">
                                            <div className="flex items-center gap-2 mb-1">
                                                <span className="text-[10px] font-black text-yellow-500">#{p.number}</span>
                                                <span className="font-bold text-sm">{p.name}</span>
                                                {status === 1 ? (
                                                    <span className="text-[8px] bg-green-500/20 text-green-500 px-1 rounded font-black">PRESENT</span>
                                                ) : (
                                                    <span className="text-[8px] bg-red-500/20 text-red-500 px-1 rounded font-black">ABSENT</span>
                                                )}
                                            </div>
                                            <p className="text-xs text-slate-400 leading-relaxed pl-6 italic">
                                                {comment || "今日表現穩定。"}
                                            </p>
                                        </div>
                                    );
                                })}
                            </div>

                            <div className="mt-12 pt-6 border-t border-white/5 text-center">
                                <p className="text-[9px] text-slate-700 font-black tracking-widest uppercase">Generated by Meiyu Tigers Performance System</p>
                            </div>
                        </div>
                    </div>

                    <footer className="fixed bottom-0 inset-x-0 p-4 bg-slate-950/80 backdrop-blur-md border-t border-white/5 text-center">
                        <div className="text-[8px] text-slate-800 font-black tracking-widest uppercase italic">Meiyu Tigers Analytics 2.2 | Screenshot Enabled</div>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
