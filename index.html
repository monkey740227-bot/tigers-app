import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from "firebase/app";
import { 
  getFirestore, doc, setDoc, collection, onSnapshot, 
  addDoc, deleteDoc, query, orderBy 
} from "firebase/firestore";
import { getAuth, signInAnonymously, onAuthStateChanged } from "firebase/auth";
import { 
  Users, Calendar, Search, Settings, Save, 
  Plus, Trash2, ChevronRight, BarChart3, Phone, AlertCircle
} from 'lucide-react';

const firebaseConfig = {
    apiKey: "AIzaSyAgz1BJI-PJLv3VIUfMQSmr6F-WkXzEMzU",
    authDomain: "mei-yu-u10.firebaseapp.com",
    projectId: "mei-yu-u10",
    storageBucket: "mei-yu-u10.firebasestorage.app",
    messagingSenderId: "157433419856",
    appId: "1:157433419856:web:07db1e6968990d5719d955"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const appId = "tigers-u10-base"; // 確保與 index.html 邏輯一致

export default function App() {
  const [user, setUser] = useState(null);
  const [view, setView] = useState('parent'); 
  const [players, setPlayers] = useState([]);
  const [dailyRecords, setDailyRecords] = useState({});
  const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
  const [searchName, setSearchName] = useState('');
  const [searchResult, setSearchResult] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    signInAnonymously(auth).catch(console.error);
    return onAuthStateChanged(auth, (u) => {
      setUser(u);
      if (u) setLoading(false);
    });
  }, []);

  useEffect(() => {
    if (!user) return;
    const memberRef = collection(db, 'artifacts', appId, 'public', 'data', 'members');
    const q = query(memberRef, orderBy('name'));
    return onSnapshot(q, (snap) => {
      setPlayers(snap.docs.map(d => ({ id: d.id, ...d.data() })));
    });
  }, [user]);

  useEffect(() => {
    if (!user) return;
    const dailyRef = collection(db, 'artifacts', appId, 'public', 'data', 'daily');
    return onSnapshot(dailyRef, (snap) => {
      const records = {};
      snap.docs.forEach(d => { records[d.id] = d.data(); });
      setDailyRecords(records);
    });
  }, [user]);

  // 出席統計計算邏輯
  const stats = useMemo(() => {
    const data = {};
    Object.values(dailyRecords).forEach(day => {
      if (day.roll) {
        Object.entries(day.roll).forEach(([pId, status]) => {
          if (!data[pId]) data[pId] = { present: 0, total: 0 };
          if (status !== 0) {
            data[pId].total++;
            if (status === 1) data[pId].present++;
          }
        });
      }
    });
    return data;
  }, [dailyRecords]);

  const handleSearch = () => {
    const term = searchName.trim();
    if (!term) return;
    // 模糊搜尋：只要包含輸入的文字就顯示
    const found = players.find(p => p.name.includes(term));
    setSearchResult(found || "not_found");
  };

  const updateRoll = async (pId, status) => {
    const dayData = dailyRecords[selectedDate] || { roll: {}, note: "" };
    const newRoll = { ...(dayData.roll || {}) };
    newRoll[pId] = newRoll[pId] === status ? 0 : status;
    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'daily', selectedDate), {
      ...dayData,
      roll: newRoll,
      updatedAt: Date.now()
    }, { merge: true });
  };

  const addPlayer = async (e) => {
    e.preventDefault();
    const name = e.target.elements.playerName.value;
    const number = e.target.elements.playerNumber.value;
    if (!name) return;
    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'members'), {
      name,
      number: number || "N/A",
      createdAt: Date.now()
    });
    e.target.reset();
  };

  if (loading) return (
    <div className="min-h-screen bg-slate-950 flex flex-col items-center justify-center">
      <div className="animate-spin rounded-full h-10 w-10 border-t-2 border-yellow-500 mb-4"></div>
      <p className="text-yellow-500 font-black italic animate-pulse tracking-tighter uppercase">Tigers Cloud Connecting...</p>
    </div>
  );

  return (
    <div className="min-h-screen bg-slate-950 text-slate-100 pb-20 font-sans">
      <nav className="p-4 flex justify-between items-center bg-slate-900/80 sticky top-0 backdrop-blur-md z-50 border-b border-white/5">
        <h1 className="text-xl font-black italic tracking-tighter">
          TIGERS <span className="text-yellow-500">U10</span>
        </h1>
        <button 
          onClick={() => {
            if (view === 'parent') {
                const pwd = prompt("教練認證密碼");
                if (pwd === "0227") setView('admin');
            } else {
                setView('parent');
            }
          }}
          className="text-[10px] font-black uppercase text-yellow-500 border border-yellow-500/30 px-3 py-1 rounded-full"
        >
          {view === 'parent' ? "Coach Login" : "Parent View"}
        </button>
      </nav>

      <main className="max-w-md mx-auto p-4 space-y-6">
        
        {view === 'parent' ? (
          <div className="space-y-6 animate-in fade-in duration-500">
            <div className="bg-slate-900 p-8 rounded-[2.5rem] border border-white/5 text-center">
              <h2 className="text-xs font-black text-yellow-400 mb-6 tracking-widest uppercase">U10 家長查詢系統</h2>
              <input 
                type="text" 
                value={searchName}
                onChange={(e) => setSearchName(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && handleSearch()}
                placeholder="輸入球員姓名 (例如：李小明)" 
                className="w-full bg-slate-950 border border-slate-800 p-4 rounded-2xl text-center text-lg font-bold focus:border-yellow-500 transition-colors outline-none mb-4"
              />
              <button 
                onClick={handleSearch}
                className="w-full bg-yellow-400 text-black font-black py-4 rounded-2xl active:scale-[0.98] transition-all"
              >
                立即查詢
              </button>

              {searchResult === "not_found" && (
                <div className="mt-6 flex items-center justify-center gap-2 text-red-400 text-sm font-bold">
                   <AlertCircle size={16}/> 找不到球員，請檢查姓名是否有誤
                </div>
              )}

              {searchResult && searchResult !== "not_found" && (
                <div className="mt-8 text-left space-y-4 animate-in slide-in-from-bottom-4">
                  <div className="bg-slate-950 p-6 rounded-3xl border border-yellow-500/20">
                    <div className="flex justify-between items-start mb-6">
                      <div>
                        <div className="text-[10px] font-black text-yellow-500 italic mb-1 uppercase"># {searchResult.number} PLAYER</div>
                        <h3 className="text-3xl font-black">{searchResult.name}</h3>
                      </div>
                      <div className="text-right">
                        <div className="text-[10px] font-black text-slate-500 uppercase">Attendance</div>
                        <div className="text-4xl font-black text-yellow-400">
                          {stats[searchResult.id] ? Math.round((stats[searchResult.id].present / stats[searchResult.id].total) * 100) : 0}
                          <span className="text-sm ml-1">%</span>
                        </div>
                        <div className="text-[10px] text-slate-500 italic">出席 {stats[searchResult.id]?.present || 0}/{stats[searchResult.id]?.total || 0} 次</div>
                      </div>
                    </div>

                    <div className="space-y-3">
                       <p className="text-xs font-black text-slate-500 uppercase tracking-widest mb-2">Recent Records</p>
                       {Object.entries(dailyRecords)
                          .filter(([date, data]) => data.roll?.[searchResult.id])
                          .sort((a, b) => b[0].localeCompare(a[0]))
                          .slice(0, 5) // 顯示最近5筆
                          .map(([date, data]) => (
                            <div key={date} className="bg-slate-900 p-4 rounded-2xl border border-white/5">
                                <div className="flex justify-between items-center mb-1">
                                    <span className="text-[10px] font-black text-slate-500">{date}</span>
                                    <span className={`text-[10px] font-black ${data.roll[searchResult.id] === 1 ? 'text-green-500' : 'text-red-500'}`}>
                                        {data.roll[searchResult.id] === 1 ? '● PRESENT' : '○ ABSENT'}
                                    </span>
                                </div>
                                <p className="text-xs text-slate-400 italic">
                                    {data.note || "今日教練未留下額外評語。"}
                                </p>
                            </div>
                          ))
                       }
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        ) : (
          /* 教練後台介面 */
          <div className="space-y-6 animate-in fade-in duration-500">
            <section className="bg-slate-900 p-4 rounded-3xl border border-white/5 space-y-4 text-center">
              <div className="flex items-center justify-between bg-slate-950 p-3 rounded-2xl">
                  <Calendar size={18} className="text-yellow-500"/>
                  <input 
                    type="date" 
                    value={selectedDate}
                    onChange={(e) => setSelectedDate(e.target.value)}
                    className="bg-transparent font-black text-sm outline-none text-center flex-1"
                  />
                  <div className="w-5"></div>
              </div>
              <textarea 
                placeholder="今日訓練重點與全隊表現備註..."
                defaultValue={dailyRecords[selectedDate]?.note || ""}
                onBlur={async (e) => {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'daily', selectedDate), {
                        note: e.target.value
                    }, { merge: true });
                }}
                className="w-full bg-slate-950 p-4 rounded-2xl text-sm border border-slate-800 focus:border-yellow-500 outline-none h-24 transition-all"
              />
            </section>

            <section className="space-y-3">
              <div className="flex justify-between items-center px-2">
                <h3 className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Attendance Sheet</h3>
                <span className="text-[10px] bg-slate-800 px-2 py-0.5 rounded text-slate-400">Total: {players.length}</span>
              </div>
              {players.map(p => {
                const status = dailyRecords[selectedDate]?.roll?.[p.id] || 0;
                return (
                  <div key={p.id} className="bg-slate-900 p-4 rounded-2xl flex justify-between items-center border border-white/5 group active:scale-95 transition-all">
                    <div className="flex flex-col">
                      <span className="font-black flex items-center gap-2">
                        {p.name} 
                        <span className="text-[10px] text-slate-500 font-normal tracking-tighter">#{p.number}</span>
                      </span>
                      <span className="text-[9px] text-slate-500 uppercase font-bold">Rate: {stats[p.id] ? Math.round((stats[p.id].present / stats[p.id].total) * 100) : 0}%</span>
                    </div>
                    <div className="flex gap-2">
                      <button 
                        onClick={() => updateRoll(p.id, 1)}
                        className={`w-12 h-12 rounded-xl text-xs font-black transition-all ${status === 1 ? 'bg-green-600' : 'bg-slate-800 text-slate-600'}`}
                      >
                        出
                      </button>
                      <button 
                        onClick={() => updateRoll(p.id, 2)}
                        className={`w-12 h-12 rounded-xl text-xs font-black transition-all ${status === 2 ? 'bg-red-600' : 'bg-slate-800 text-slate-600'}`}
                      >
                        缺
                      </button>
                    </div>
                  </div>
                );
              })}
            </section>

            {/* 球員名單管理 */}
            <section className="bg-slate-900/50 p-6 rounded-3xl border border-dashed border-slate-800">
              <h3 className="text-[10px] font-black text-slate-500 uppercase mb-4 tracking-widest flex items-center gap-2">
                <Plus size={14}/> Add New Member
              </h3>
              <form onSubmit={addPlayer} className="flex gap-2 mb-6">
                <input name="playerName" placeholder="姓名" className="flex-[2] bg-slate-950 p-3 rounded-xl text-xs border border-slate-800 outline-none" required />
                <input name="playerNumber" placeholder="背號" className="flex-1 bg-slate-950 p-3 rounded-xl text-xs border border-slate-800 outline-none" />
                <button type="submit" className="bg-yellow-400 text-black px-4 rounded-xl active:scale-95 transition-transform">
                  <Plus size={18}/>
                </button>
              </form>
              <div className="grid grid-cols-2 gap-2">
                {players.map(p => (
                  <div key={p.id} className="bg-slate-950 p-3 rounded-xl flex justify-between items-center">
                    <span className="text-xs font-bold text-slate-400">{p.name}</span>
                    <button onClick={() => {
                        if(confirm(`確定刪除 ${p.name}？`)) deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'members', p.id))
                    }} className="text-slate-700 hover:text-red-500">
                      <Trash2 size={12}/>
                    </button>
                  </div>
                ))}
              </div>
            </section>
          </div>
        )}
      </main>

      <footer className="fixed bottom-0 left-0 right-0 p-4 text-center pointer-events-none">
        <div className="bg-slate-950/80 backdrop-blur-sm border border-white/5 inline-block px-4 py-1 rounded-full">
          <p className="text-[9px] text-slate-500 font-bold uppercase tracking-[0.2em]">
            Mei Yu Tigers U10 Management System v2.1
          </p>
        </div>
      </footer>
    </div>
  );
}
