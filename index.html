import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInWithCustomToken, 
  signInAnonymously, 
  onAuthStateChanged 
} from 'firebase/auth';
import { 
  getFirestore, 
  doc, 
  setDoc, 
  onSnapshot,
  serverTimestamp 
} from 'firebase/firestore';
import { 
  Users, UserCheck, Activity, Download, Plus, Trash2, ShieldCheck, AlertCircle, Loader2, ChevronRight
} from 'lucide-react';

// --- 核心配置 (由環境變數注入) ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'tigers-u12-pro';

export default function App() {
  // 系統狀態
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [activeTab, setActiveTab] = useState('attendance');
  const [isCapturing, setIsCapturing] = useState(false);
  const captureRef = useRef(null);

  // 業務資料狀態
  const [data, setData] = useState({
    members: [],
    coaches: [],
    lastUpdated: null
  });

  // 1. 身份驗證與初始化 (規則 3)
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {
        console.error("Auth Error:", err);
        setError("身份驗證失敗，請確認 Firebase 設定。");
      }
    };

    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (u) => {
      setUser(u);
      if (u) setLoading(false);
    });

    return () => unsubscribe();
  }, []);

  // 2. 實時數據監聽 (規則 1: 嚴謹路徑)
  useEffect(() => {
    if (!user) return;

    // 格式: /artifacts/{appId}/public/data/main/current
    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'main', 'current');
    
    const unsubscribe = onSnapshot(docRef, 
      (docSnap) => {
        if (docSnap.exists()) {
          setData(docSnap.data());
        } else {
          // 初始化雲端文檔
          const initialData = { members: [], coaches: [], lastUpdated: new Date().toISOString() };
          setDoc(docRef, initialData);
          setData(initialData);
        }
        setError(null);
      },
      (err) => {
        console.error("Firestore Error:", err);
        setError(`權限不足或路徑錯誤 (Code: ${err.code})`);
      }
    );

    return () => unsubscribe();
  }, [user]);

  // 3. 數據同步函式
  const persistData = async (newData) => {
    if (!user) return;
    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'main', 'current');
    try {
      await setDoc(docRef, { ...newData, lastUpdated: new Date().toISOString() });
    } catch (err) {
      setError("儲存失敗，請檢查網路連線。");
    }
  };

  // 4. 業務邏輯處理
  const toggleAttendance = (id) => {
    const newMembers = data.members.map(m => {
      if (m.id === id) {
        const states = ['present', 'absent', 'late'];
        const nextIdx = (states.indexOf(m.status || 'present') + 1) % states.length;
        return { ...m, status: states[nextIdx] };
      }
      return m;
    });
    const newData = { ...data, members: newMembers };
    setData(newData); // 即時更新 UI
    persistData(newData); // 非同步同步雲端
  };

  const addPerson = (type) => {
    const name = prompt(`請輸入${type === 'coaches' ? '教練' : '隊員'}姓名:`);
    if (!name) return;
    const newItem = {
      id: `${type}-${Date.now()}`,
      name,
      status: 'present',
      note: '',
      role: type === 'coaches' ? 'Coach' : 'Player'
    };
    const newData = { ...data, [type]: [...data[type], newItem] };
    persistData(newData);
  };

  const deletePerson = (type, id) => {
    if (!window.confirm("確定移除此成員？")) return;
    const newData = { ...data, [type]: data[type].filter(p => p.id !== id) };
    persistData(newData);
  };

  const updateNote = (id, note) => {
    const newMembers = data.members.map(m => m.id === id ? { ...m, note } : m);
    persistData({ ...data, members: newMembers });
  };

  // 5. 截圖報表生成
  const handleExport = async () => {
    if (!captureRef.current) return;
    setIsCapturing(true);
    // 引入 html2canvas 腳本
    if (!window.html2canvas) {
      const script = document.createElement('script');
      script.src = "https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js";
      document.head.appendChild(script);
      await new Promise(r => script.onload = r);
    }
    
    setTimeout(async () => {
      const canvas = await window.html2canvas(captureRef.current, { backgroundColor: '#f8fafc', scale: 2 });
      const link = document.createElement('a');
      link.href = canvas.toDataURL("image/png");
      link.download = `Tigers_Report_${new Date().toISOString().slice(0,10)}.png`;
      link.click();
      setIsCapturing(false);
    }, 100);
  };

  if (loading) return (
    <div className="h-screen flex flex-col items-center justify-center bg-slate-900 text-white">
      <Loader2 className="animate-spin text-yellow-500 mb-4" size={40} />
      <p className="font-bold tracking-widest text-sm italic">TIGERS CLOUD CONNECTING...</p>
    </div>
  );

  return (
    <div className="max-w-md mx-auto min-h-screen bg-slate-50 flex flex-col font-sans text-slate-900 pb-20">
      {/* Header */}
      <header className="bg-slate-900 text-white p-6 rounded-b-[2.5rem] shadow-xl">
        <div className="flex justify-between items-start">
          <div>
            <h1 className="text-2xl font-black italic tracking-tighter text-yellow-500">MEI-YU TIGERS</h1>
            <p className="text-[10px] font-bold opacity-60 uppercase tracking-widest mt-1">
              {appId} / {new Date().toLocaleDateString('zh-TW')}
            </p>
          </div>
          <div className="bg-slate-800 p-2 rounded-full">
            <ShieldCheck size={20} className="text-green-400" />
          </div>
        </div>

        {error && (
          <div className="mt-4 bg-red-500/20 border border-red-500/50 p-3 rounded-xl flex items-center gap-2 text-xs text-red-200">
            <AlertCircle size={14} />
            <span>{error}</span>
          </div>
        )}
      </header>

      {/* Tabs */}
      <nav className="flex px-6 -mt-6 gap-2">
        {[
          { id: 'attendance', label: '點名', icon: UserCheck },
          { id: 'training', label: '表現', icon: Activity },
          { id: 'manage', label: '名單', icon: Users }
        ].map(tab => (
          <button
            key={tab.id}
            onClick={() => setActiveTab(tab.id)}
            className={`flex-1 flex items-center justify-center gap-2 py-3 rounded-2xl font-bold text-sm transition-all shadow-lg ${
              activeTab === tab.id ? 'bg-yellow-500 text-slate-900 scale-105' : 'bg-white text-slate-400'
            }`}
          >
            <tab.icon size={16} />
            {tab.label}
          </button>
        ))}
      </nav>

      {/* Main Content */}
      <main ref={captureRef} className="flex-1 p-6 space-y-8">
        {activeTab === 'attendance' && (
          <section className="animate-in slide-in-from-bottom-4 duration-500">
            <div className="flex items-center justify-between mb-4">
              <h2 className="font-black text-slate-800 flex items-center gap-2">
                今日出席 <span className="text-[10px] bg-slate-200 px-2 py-0.5 rounded-full">{data.members.filter(m => m.status === 'present').length}/{data.members.length}</span>
              </h2>
            </div>
            
            <div className="grid grid-cols-3 gap-3">
              {data.members.map(member => (
                <button
                  key={member.id}
                  onClick={() => toggleAttendance(member.id)}
                  className={`p-3 rounded-2xl border-2 transition-all flex flex-col items-center gap-1 ${
                    member.status === 'present' ? 'bg-white border-green-500 text-green-700' :
                    member.status === 'late' ? 'bg-yellow-50 border-yellow-400 text-yellow-700' :
                    'bg-red-50 border-red-200 text-red-400 opacity-60'
                  }`}
                >
                  <span className="font-black text-xs truncate w-full">{member.name}</span>
                  <span className="text-[8px] font-bold uppercase tracking-tighter">
                    {member.status === 'present' ? '在席' : member.status === 'late' ? '遲到' : '缺席'}
                  </span>
                </button>
              ))}
              {!isCapturing && (
                <button onClick={() => addPerson('members')} className="border-2 border-dashed border-slate-300 rounded-2xl flex items-center justify-center text-slate-300 h-16">
                  <Plus size={20} />
                </button>
              )}
            </div>
          </section>
        )}

        {activeTab === 'training' && (
          <section className="space-y-4 animate-in fade-in duration-500">
            <h2 className="font-black text-slate-800">教練技術筆記</h2>
            {data.members.map(member => (
              <div key={member.id} className="bg-white p-4 rounded-3xl shadow-sm border border-slate-100">
                <div className="flex justify-between items-center mb-2">
                  <span className="font-black text-slate-700">{member.name}</span>
                  <div className={`w-2 h-2 rounded-full ${member.status === 'present' ? 'bg-green-500' : 'bg-red-400'}`}></div>
                </div>
                <textarea
                  value={member.note || ''}
                  onChange={(e) => updateNote(member.id, e.target.value)}
                  placeholder="紀錄球員今日表現..."
                  className="w-full text-xs bg-slate-50 rounded-xl p-3 border-none focus:ring-1 focus:ring-yellow-500 h-20 resize-none"
                />
              </div>
            ))}
          </section>
        )}

        {activeTab === 'manage' && (
          <section className="space-y-6 animate-in fade-in duration-500">
            {['coaches', 'members'].map(type => (
              <div key={type} className="bg-white rounded-3xl overflow-hidden border border-slate-100 shadow-sm">
                <div className="p-4 bg-slate-50 border-b flex justify-between items-center">
                  <span className="font-black text-[10px] uppercase tracking-widest text-slate-400">{type === 'coaches' ? 'Coach Staff' : 'Squad Roster'}</span>
                  <button onClick={() => addPerson(type)} className="text-blue-500"><Plus size={18}/></button>
                </div>
                <div className="divide-y divide-slate-50">
                  {data[type].map(person => (
                    <div key={person.id} className="p-4 flex justify-between items-center">
                      <span className="font-bold text-slate-700">{person.name}</span>
                      <button onClick={() => deletePerson(type, person.id)} className="text-slate-300 hover:text-red-500 transition-colors">
                        <Trash2 size={16} />
                      </button>
                    </div>
                  ))}
                </div>
              </div>
            ))}
          </section>
        )}
      </main>

      {/* Floating Action Button */}
      {activeTab === 'attendance' && !isCapturing && (
        <button
          onClick={handleExport}
          className="fixed bottom-6 right-6 bg-slate-900 text-white p-4 rounded-full shadow-2xl hover:scale-110 active:scale-90 transition-all z-50"
        >
          <Download size={24} />
        </button>
      )}

      {/* Footer Branding */}
      <footer className="p-8 text-center">
        <p className="text-[10px] font-black text-slate-300 tracking-[0.2em] uppercase">Powered by Football Pro System</p>
      </footer>
    </div>
  );
}
