<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tigers Elite - Auth Fix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, query, limit } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        let db, auth, user;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'tigers-elite-v1';

        function updateStatus(msg, isError = false) {
            const el = document.getElementById('status-bar');
            if (el) {
                el.innerText = msg;
                el.className = `p-2 text-[10px] font-mono border-b ${isError ? 'bg-red-900 text-white' : 'bg-slate-900 text-slate-400'}`;
            }
            console.log(msg);
        }

        async function initSystem() {
            updateStatus("正在檢查系統金鑰...");
            
            // 迴圈檢查直到環境變數可用
            let attempts = 0;
            while (typeof __firebase_config === 'undefined' && attempts < 10) {
                attempts++;
                updateStatus(`等待系統配置中... (${attempts}/10)`);
                await new Promise(r => setTimeout(r, 500));
            }

            if (typeof __firebase_config === 'undefined') {
                updateStatus("致命錯誤：無法取得 API Key，請嘗試重新整理網頁。", true);
                return;
            }

            try {
                const firebaseConfig = JSON.parse(__firebase_config);
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                updateStatus("金鑰驗證通過，正在建立安全連線...");

                // 優先使用 Custom Token
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (u) => {
                    if (u) {
                        user = u;
                        updateStatus(`連線成功 (UID: ${u.uid.substring(0,8)}...)`);
                        startDataSync();
                    }
                });

            } catch (err) {
                updateStatus(`初始化失敗: ${err.message}`, true);
            }
        }

        function startDataSync() {
            const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'members');
            
            // 遵守規則：不使用複雜查詢，避免 index 錯誤
            onSnapshot(colRef, (snap) => {
                const members = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderApp(members);
            }, (err) => {
                updateStatus(`數據讀取失敗: ${err.message}`, true);
            });
        }

        function renderApp(members) {
            const container = document.getElementById('app-content');
            container.innerHTML = `
                <div class="p-6 max-w-md mx-auto">
                    <header class="flex justify-between items-end mb-8">
                        <div>
                            <h1 class="text-3xl font-black italic text-amber-500 leading-none">TIGERS</h1>
                            <p class="text-xs tracking-widest text-slate-500 uppercase">U9/U10 Elite Squad</p>
                        </div>
                        <div class="text-right">
                            <span class="text-xs font-mono text-slate-600">LIVE SYNC</span>
                        </div>
                    </header>

                    <div class="space-y-3">
                        ${members.length === 0 ? '<div class="py-10 text-center text-slate-600 border border-dashed border-slate-800 rounded-2xl">目前沒有成員</div>' : ''}
                        ${members.map(m => `
                            <div class="bg-slate-900/50 border border-slate-800 p-4 rounded-2xl flex justify-between items-center group active:scale-95 transition-transform">
                                <div>
                                    <h3 class="font-bold text-lg">${m.name}</h3>
                                    <p class="text-[10px] text-slate-500 font-mono uppercase">${m.id.substring(0,6)}</p>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="px-2 py-1 rounded-md text-[10px] bg-slate-800 text-slate-400 font-bold uppercase">${m.role || 'U9'}</span>
                                    <div class="w-3 h-3 rounded-full ${m.status === 'present' ? 'bg-green-500 shadow-[0_0_12px_rgba(34,197,94,0.4)]' : 'bg-slate-700'}"></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <button onclick="addMember()" class="mt-8 w-full py-4 bg-amber-500 hover:bg-amber-400 text-slate-950 font-black rounded-2xl uppercase italic tracking-widest transition-colors shadow-lg shadow-amber-500/20">
                        Add New Player
                    </button>
                </div>
            `;
        }

        window.addMember = async () => {
            const name = prompt("請輸入球員姓名：");
            if (!name || !user) return;
            
            try {
                updateStatus("正在存入數據...");
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'members'), {
                    name,
                    role: 'u9',
                    status: 'present',
                    updatedBy: user.uid,
                    timestamp: new Date().toISOString()
                });
                updateStatus("數據存入成功");
            } catch (err) {
                updateStatus(`存入失敗: ${err.message}`, true);
            }
        };

        window.onload = initSystem;
    </script>
    <style>
        body { background-color: #020617; color: #f8fafc; font-family: system-ui, -apple-system, sans-serif; }
    </style>
</head>
<body>
    <div id="status-bar">正在載入環境配置...</div>
    <div id="app-content">
        <div class="flex flex-col items-center justify-center min-h-[80vh]">
            <div class="w-8 h-8 border-2 border-slate-800 border-t-amber-500 rounded-full animate-spin"></div>
            <p class="mt-4 text-[10px] uppercase tracking-[0.2em] text-slate-500 animate-pulse">Establishing Secure Link</p>
        </div>
    </div>
</body>
</html>