import React, { useState, useRef, useEffect } from 'react';
import { 
  Users, 
  UserCheck, 
  Activity, 
  Camera, 
  Plus, 
  Trash2, 
  Download,
  ShieldCheck,
  Settings,
  ChevronRight
} from 'lucide-react';

// 初始數據結構
const INITIAL_DATA = {
  u9: [
    { id: 'u9-1', name: '林小明', attendance: 'present', trainingStatus: '良好', note: '盤球重心穩定' },
    { id: 'u9-2', name: '陳小華', attendance: 'absent', trainingStatus: '普通', note: '感冒請假' }
  ],
  u10: [
    { id: 'u10-1', name: '張大強', attendance: 'present', trainingStatus: '優秀', note: '射門力道極佳' }
  ],
  coaches: [
    { id: 'c1', name: '王教練', role: '總教練' },
    { id: 'c2', name: '李教練', role: '助理教練' }
  ]
};

const App = () => {
  const [data, setData] = useState(INITIAL_DATA);
  const [activeTab, setActiveTab] = useState('attendance');
  const [isCapturing, setIsCapturing] = useState(false);
  const captureRef = useRef(null);

  // 動態載入 html2canvas 以支援截圖
  useEffect(() => {
    const script = document.createElement('script');
    script.src = "https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js";
    script.async = true;
    document.body.appendChild(script);
    return () => { document.body.removeChild(script); };
  }, []);

  // --- 功能邏輯 ---

  const handleCapture = async () => {
    if (!captureRef.current || !window.html2canvas) return;
    setIsCapturing(true);
    setTimeout(async () => {
      const canvas = await window.html2canvas(captureRef.current, { backgroundColor: '#f1f5f9', scale: 2 });
      const link = document.createElement('a');
      link.href = canvas.toDataURL("image/png");
      link.download = `點名報表_${new Date().toISOString().split('T')[0]}.png`;
      link.click();
      setIsCapturing(false);
    }, 300);
  };

  const updateStatus = (cat, id, field, value) => {
    setData(prev => ({
      ...prev,
      [cat]: prev[cat].map(item => item.id === id ? { ...item, [field]: value } : item)
    }));
  };

  const addPerson = (cat) => {
    const name = prompt("輸入姓名:");
    if (!name) return;
    const newItem = {
      id: `${cat}-${Date.now()}`,
      name,
      attendance: 'present',
      trainingStatus: '普通',
      note: '',
      role: cat === 'coaches' ? '教練' : '球員'
    };
    setData(prev => ({ ...prev, [cat]: [...prev[cat], newItem] }));
  };

  const deletePerson = (cat, id) => {
    if (confirm("確定刪除？")) {
      setData(prev => ({ ...prev, [cat]: prev[cat].filter(i => i.id !== id) }));
    }
  };

  // --- UI 組件 ---

  const SectionHeader = ({ title, cat }) => (
    <div className="flex justify-between items-center mb-3 px-1">
      <h3 className="text-lg font-black text-slate-700 flex items-center gap-2">
        <div className="w-2 h-6 bg-yellow-500 rounded-full"></div>
        {title} <span className="text-sm font-normal text-slate-400">({data[cat].length})</span>
      </h3>
      {!isCapturing && (
        <button onClick={() => addPerson(cat)} className="text-blue-600 p-1 hover:bg-blue-50 rounded">
          <Plus size={20} />
        </button>
      )}
    </div>
  );

  return (
    <div className="max-w-md mx-auto bg-slate-100 min-h-screen font-sans pb-24">
      {/* Navbar */}
      <nav className="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b flex justify-around p-3 shadow-sm">
        {[
          { id: 'attendance', label: '點名', icon: UserCheck },
          { id: 'training', label: '訓練', icon: Activity },
          { id: 'manage', label: '編輯', icon: Settings }
        ].map(tab => (
          <button 
            key={tab.id}
            onClick={() => setActiveTab(tab.id)}
            className={`flex flex-col items-center gap-1 transition-all ${activeTab === tab.id ? 'text-blue-600 scale-110' : 'text-slate-400'}`}
          >
            <tab.icon size={20} />
            <span className="text-[10px] font-bold">{tab.label}</span>
          </button>
        ))}
      </nav>

      {/* Main Content */}
      <div ref={captureRef} className="p-4 space-y-8">
        
        {/* 1. 出缺席狀況 (點名) */}
        {activeTab === 'attendance' && (
          <div className="animate-in fade-in slide-in-from-top-2">
            <div className="flex justify-between items-end mb-6">
              <div>
                <h1 className="text-2xl font-black text-slate-800">每日點名回報</h1>
                <p className="text-xs text-slate-400">{new Date().toLocaleDateString()} 課程紀錄</p>
              </div>
              {!isCapturing && (
                <button onClick={handleCapture} className="bg-slate-800 text-white p-3 rounded-full shadow-lg active:scale-95 transition">
                  <Camera size={20} />
                </button>
              )}
            </div>

            {['u9', 'u10', 'coaches'].map(cat => (
              <div key={cat} className="mb-8">
                <SectionHeader title={cat.toUpperCase() + (cat === 'coaches' ? ' 教練組' : ' 梯隊')} cat={cat} />
                <div className="grid grid-cols-3 gap-2">
                  {data[cat].map(item => (
                    <div 
                      key={item.id}
                      onClick={() => cat !== 'coaches' && updateStatus(cat, item.id, 'attendance', item.attendance === 'present' ? 'absent' : (item.attendance === 'absent' ? 'late' : 'present'))}
                      className={`p-3 rounded-xl border-2 text-center transition-all ${
                        cat === 'coaches' ? 'bg-white border-slate-200' :
                        item.attendance === 'present' ? 'bg-green-50 border-green-500 text-green-700' :
                        item.attendance === 'late' ? 'bg-yellow-50 border-yellow-500 text-yellow-700' :
                        'bg-red-50 border-red-500 text-red-700'
                      }`}
                    >
                      <div className="font-bold text-sm truncate">{item.name}</div>
                      <div className="text-[10px] opacity-70">
                        {cat === 'coaches' ? item.role : (item.attendance === 'present' ? '出席' : item.attendance === 'late' ? '遲到' : '缺席')}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            ))}
            {isCapturing && <div className="text-center text-[10px] text-slate-400 mt-10 italic">基石足球系統自動生成</div>}
          </div>
        )}

        {/* 2. 個人訓練狀況 */}
        {activeTab === 'training' && (
          <div className="space-y-6 animate-in fade-in">
            <h1 className="text-2xl font-black text-slate-800 mb-4">訓練評核紀錄</h1>
            {['u9', 'u10'].map(cat => (
              <div key={cat}>
                <SectionHeader title={cat.toUpperCase() + " 訓練紀錄"} cat={cat} />
                {data[cat].map(person => (
                  <div key={person.id} className="bg-white p-4 rounded-2xl mb-3 shadow-sm border border-slate-100">
                    <div className="flex justify-between items-center mb-2">
                      <span className="font-bold text-slate-700">{person.name}</span>
                      <select 
                        value={person.trainingStatus}
                        onChange={(e) => updateStatus(cat, person.id, 'trainingStatus', e.target.value)}
                        className="text-xs bg-slate-50 border-none rounded-lg px-2 py-1 font-bold text-blue-600 outline-none"
                      >
                        <option value="優秀">優秀</option>
                        <option value="良好">良好</option>
                        <option value="普通">普通</option>
                        <option value="待加強">待加強</option>
                      </select>
                    </div>
                    <textarea 
                      value={person.note}
                      onChange={(e) => updateStatus(cat, person.id, 'note', e.target.value)}
                      placeholder="輸入訓練觀察..."
                      className="w-full text-xs p-2 bg-slate-50 rounded-lg h-16 resize-none border-none focus:ring-1 focus:ring-blue-100"
                    />
                  </div>
                ))}
              </div>
            ))}
          </div>
        )}

        {/* 3. 人員管理編輯 */}
        {activeTab === 'manage' && (
          <div className="space-y-6 animate-in fade-in">
             <h1 className="text-2xl font-black text-slate-800 mb-4">系統名單管理</h1>
             {['u9', 'u10', 'coaches'].map(cat => (
               <div key={cat} className="bg-white rounded-2xl overflow-hidden shadow-sm border border-slate-100">
                 <div className="bg-slate-50 p-3 border-b flex justify-between items-center">
                   <span className="font-bold text-slate-500 text-sm uppercase">{cat} List</span>
                   <button onClick={() => addPerson(cat)} className="bg-blue-600 text-white p-1 rounded-md"><Plus size={14}/></button>
                 </div>
                 <div className="divide-y divide-slate-50">
                    {data[cat].map(person => (
                      <div key={person.id} className="p-3 flex justify-between items-center">
                        <span className="font-medium text-slate-700">{person.name}</span>
                        <div className="flex items-center gap-3">
                          <span className="text-[10px] text-slate-400">{cat === 'coaches' ? person.role : '學員'}</span>
                          <button onClick={() => deletePerson(cat, person.id)} className="text-slate-300 hover:text-red-500"><Trash2 size={16}/></button>
                        </div>
                      </div>
                    ))}
                 </div>
               </div>
             ))}
          </div>
        )}

      </div>

      {/* Floating Download Button */}
      {activeTab === 'attendance' && !isCapturing && (
        <button 
          onClick={handleCapture}
          className="fixed bottom-6 right-6 bg-blue-600 text-white p-4 rounded-full shadow-2xl animate-bounce"
        >
          <Download size={24} />
        </button>
      )}
    </div>
  );
};

export default App;
