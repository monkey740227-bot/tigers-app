<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>美育虎U10 - 專業管理系統</title>
    
    <!-- 1. 載入 CSS 與核心 React 庫 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 2. 載入 Firebase 完整庫 (使用 UMD 格式以避開 require 問題) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #020617; color: #f1f5f9; }
        .tiger-gradient { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        // 由於使用了 compat 版本，我們直接從 firebase 全域變數獲取功能
        const firebase = window.firebase;
        const { useState, useEffect, useMemo } = React;

        // Firebase 配置
        const firebaseConfig = {
            apiKey: "AIzaSyAgz1BJI-PJLv3VIUfMQSmr6F-WkXzEMzU",
            authDomain: "mei-yu-u10.firebaseapp.com",
            projectId: "mei-yu-u10",
            storageBucket: "mei-yu-u10.firebasestorage.app",
            messagingSenderId: "157433419856",
            appId: "1:157433419856:web:07db1e6968990d5719d955"
        };

        // 初始化 Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        const db = firebase.firestore();
        const auth = firebase.auth();
        const appId = "tigers-u10";

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('parent');
            const [players, setPlayers] = useState([]);
            const [dailyRecords, setDailyRecords] = useState({});
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            const [searchName, setSearchName] = useState('');
            const [searchResult, setSearchResult] = useState(null);
            const [loading, setLoading] = useState(true);

            // 登入邏輯
            useEffect(() => {
                auth.signInAnonymously().catch(err => console.error("Firebase Auth Error:", err));
                return auth.onAuthStateChanged((u) => {
                    setUser(u);
                    if (u) setLoading(false);
                });
            }, []);

            // 資料監聽
            useEffect(() => {
                if (!user) return;
                
                // 監聽成員
                const unsubMembers = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('members')
                    .orderBy('name')
                    .onSnapshot((snap) => {
                        setPlayers(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                    });

                // 監聽日誌
                const unsubDaily = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('daily')
                    .onSnapshot((snap) => {
                        const records = {};
                        snap.docs.forEach(d => { records[d.id] = d.data(); });
                        setDailyRecords(records);
                    });

                return () => { unsubMembers(); unsubDaily(); };
            }, [user]);

            // 出勤累計計算
            const stats = useMemo(() => {
                const counts = {};
                Object.values(dailyRecords).forEach(day => {
                    Object.entries(day.roll || {}).forEach(([pId, status]) => {
                        if (status === 1) counts[pId] = (counts[pId] || 0) + 1;
                    });
                });
                return counts;
            }, [dailyRecords]);

            const handleSave = async () => {
                const note = document.getElementById('daily-note').value;
                const currentRoll = dailyRecords[selectedDate]?.roll || {};
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('daily').doc(selectedDate).set({
                    roll: currentRoll, note, updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert("✅ 雲端同步成功！");
            };

            const updateRoll = async (pId, status) => {
                const dayData = dailyRecords[selectedDate] || { roll: {}, note: "" };
                const newRoll = { ...dayData.roll };
                newRoll[pId] = newRoll[pId] === status ? 0 : status;
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('daily').doc(selectedDate).set({
                    ...dayData, roll: newRoll
                });
            };

            if (loading) return (
                <div className="flex h-screen items-center justify-center bg-slate-950 text-yellow-500 font-black animate-pulse text-2xl italic">
                    TIGERS CONNECTING...
                </div>
            );

            return (
                <div className="min-h-screen bg-slate-950 text-slate-100">
                    <nav className="sticky top-0 z-50 flex items-center justify-between bg-slate-900/80 p-4 backdrop-blur-md border-b border-white/5">
                        <div className="text-xl font-black italic">TIGERS <span className="text-yellow-500 underline decoration-2">U10</span></div>
                        <button 
                            onClick={() => {
                                if (view === 'parent') {
                                    const pwd = prompt("教練認證密碼");
                                    if (pwd === "0227") setView('admin');
                                } else { setView('parent'); }
                            }}
                            className="bg-slate-800 px-4 py-2 rounded-full text-[10px] font-bold tracking-widest border border-white/10 uppercase"
                        >
                            {view === 'parent' ? "Coach Login" : "Switch to Parent"}
                        </button>
                    </nav>

                    <main className="max-w-md mx-auto p-4 pb-20">
                        {view === 'parent' ? (
                            <div className="space-y-6">
                                <div className="tiger-gradient p-8 rounded-[2.5rem] border border-white/5 shadow-2xl">
                                    <h2 className="text-center text-lg font-bold mb-6 italic">PLAYER SEARCH</h2>
                                    <input 
                                        type="text" 
                                        placeholder="請輸入學員姓名"
                                        className="w-full bg-slate-950 border border-slate-700 p-4 rounded-2xl text-center text-xl focus:border-yellow-500 outline-none transition-all"
                                        value={searchName}
                                        onChange={e => setSearchName(e.target.value)}
                                    />
                                    <button 
                                        onClick={() => setSearchResult(players.find(x => x.name === searchName) || "not_found")}
                                        className="w-full mt-4 bg-yellow-500 text-black font-black py-4 rounded-2xl shadow-lg active:scale-95 transition-transform"
                                    >
                                        立即查詢
                                    </button>

                                    {searchResult && searchResult !== "not_found" && (
                                        <div className="mt-8 p-6 bg-slate-950 rounded-3xl border-l-4 border-yellow-500 animate-in">
                                            <div className="flex justify-between items-end mb-4 border-b border-white/5 pb-4">
                                                <div>
                                                    <p className="text-[10px] font-bold text-slate-400">PLAYER NAME</p>
                                                    <h3 className="text-2xl font-black">{searchResult.name}</h3>
                                                </div>
                                                <div className="text-right">
                                                    <p className="text-[10px] font-bold text-slate-400">ATTENDANCE</p>
                                                    <h3 className="text-2xl font-black text-yellow-500">{stats[searchResult.id] || 0} 次</h3>
                                                </div>
                                            </div>
                                            <div className="bg-slate-800/50 p-4 rounded-2xl text-sm border border-white/5">
                                                <p className="text-yellow-500 font-bold text-[10px] mb-1 italic uppercase tracking-tighter">Status @ {selectedDate}</p>
                                                <p className="font-bold">{dailyRecords[selectedDate]?.roll?.[searchResult.id] === 1 ? "✅ 今日正常出席訓練" : "❌ 今日未參加訓練"}</p>
                                                <div className="mt-2 pt-2 border-t border-white/5 text-slate-400 text-xs">
                                                    <span className="text-slate-500 font-bold uppercase text-[9px]">Coach Note:</span><br/>
                                                    {dailyRecords[selectedDate]?.note || "今日無特別註記"}
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-6 animate-in">
                                <div className="bg-slate-900 p-6 rounded-3xl border border-white/5 shadow-xl">
                                    <div className="flex justify-between items-center mb-4">
                                        <input 
                                            type="date" 
                                            className="bg-slate-950 p-2 rounded-xl text-xs font-bold border border-white/5"
                                            value={selectedDate}
                                            onChange={e => setSelectedDate(e.target.value)}
                                        />
                                        <button onClick={handleSave} className="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-xl text-xs font-bold transition-colors">同步雲端</button>
                                    </div>
                                    <textarea 
                                        id="daily-note"
                                        className="w-full bg-slate-950 p-3 rounded-xl text-sm h-24 outline-none border border-white/5 focus:border-blue-500/50"
                                        placeholder="今日訓練註記（教練專用）..."
                                        defaultValue={dailyRecords[selectedDate]?.note || ""}
                                    />
                                </div>

                                <div className="space-y-2">
                                    <p className="text-[10px] font-bold text-slate-500 px-2 tracking-widest uppercase">Member Roll Call</p>
                                    {players.length === 0 && <div className="text-center p-8 text-slate-600 italic text-sm">尚未建立成員名單</div>}
                                    {players.map(p => {
                                        const status = dailyRecords[selectedDate]?.roll?.[p.id] || 0;
                                        return (
                                            <div key={p.id} className="flex justify-between items-center bg-slate-900 p-4 rounded-2xl border border-white/5 hover:border-white/10 transition-colors">
                                                <div>
                                                    <div className="font-bold text-slate-200">{p.name} <span className="text-[10px] text-slate-600 font-normal">#{p.number || '00'}</span></div>
                                                    <div className="text-[10px] text-slate-500 font-bold">總出席：{stats[p.id] || 0}</div>
                                                </div>
                                                <div className="flex gap-2">
                                                    <button 
                                                        onClick={() => updateRoll(p.id, 1)}
                                                        className={`w-12 py-2 rounded-xl text-xs font-black transition-all ${status === 1 ? 'bg-green-600 text-white shadow-lg shadow-green-900/20' : 'bg-slate-800 text-slate-600'}`}
                                                    >出</button>
                                                    <button 
                                                        onClick={() => updateRoll(p.id, 2)}
                                                        className={`w-12 py-2 rounded-xl text-xs font-black transition-all ${status === 2 ? 'bg-red-600 text-white shadow-lg shadow-red-900/20' : 'bg-slate-800 text-slate-600'}`}
                                                    >缺</button>
                                                </div>
                                            </div>
                                        )
                                    })}
                                </div>
                            </div>
                        )}
                    </main>
                    
                    <footer className="fixed bottom-0 left-0 right-0 p-4 bg-slate-950/80 backdrop-blur-sm text-center">
                        <p className="text-[9px] text-slate-700 font-bold tracking-widest uppercase italic">Meiyu Tigers U10 Management System</p>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
